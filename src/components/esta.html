<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المساعدات الإنسانية - إدارة الطرود</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
            color: #334155;
            direction: rtl;
            font-size: 14px;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #ffffff;
            border-left: 1px solid #e2e8f0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .logo {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .menu-section {
            padding: 16px 0;
        }

        .menu-title {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 24px;
            margin-bottom: 8px;
        }

        .menu-item {
            margin: 2px 16px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-link:hover {
            background-color: #f1f5f9;
            color: #334155;
        }

        .menu-link.active {
            background-color: #eff6ff;
            color: #3b82f6;
            border-right: 3px solid #3b82f6;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            margin-left: 12px;
        }

        .menu-text {
            flex: 1;
        }

        .menu-arrow {
            width: 16px;
            height: 16px;
            color: #94a3b8;
            transition: transform 0.3s ease;
        }

        .menu-item.expanded .menu-arrow {
            transform: rotate(180deg);
        }

        .submenu {
            background: #f8fafc;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin: 4px 16px;
            border-radius: 8px;
        }

        .menu-item.expanded .submenu {
            max-height: 400px;
        }

        .submenu-link {
            display: block;
            padding: 10px 16px 10px 48px;
            color: #64748b;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.2s ease;
            border-radius: 6px;
            margin: 2px 8px;
        }

        .submenu-link:hover {
            background-color: #e2e8f0;
            color: #334155;
        }

        .submenu-link.active {
            background-color: #dbeafe;
            color: #3b82f6;
        }

        /* Main Content */
        .main-content {
            margin-right: 280px;
            flex: 1;
            min-height: 100vh;
            background-color: #f8fafc;
        }

        .header {
            background: #ffffff;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            font-size: 14px;
            color: #334155;
            direction: rtl;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            width: 18px;
            height: 18px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-btn, .theme-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #64748b;
        }

        .notification-btn:hover, .theme-btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .user-profile:hover {
            background: #f8fafc;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .user-info h4 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .user-info p {
            font-size: 12px;
            color: #64748b;
        }

        /* Content Area */
        .content-area {
            padding: 24px;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 16px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .breadcrumb-item {
            color: #64748b;
        }

        .breadcrumb-item.active {
            color: #3b82f6;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-info h3 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-info p {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Button Styles */
        .btn {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            background: white;
            color: #64748b;
        }

        .btn:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px 24px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-size: 14px;
            color: #1e293b;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-inactive {
            background: #fee2e2;
            color: #dc2626;
        }

        .status-draft {
            background: #f1f5f9;
            color: #64748b;
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .form-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Package type styles */
        .package-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .package-type-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .package-type-card:hover {
            border-color: #3b82f6;
        }

        .package-type-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .package-type-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .package-type-desc {
            font-size: 12px;
            color: #64748b;
        }

        /* Contents Table */
        .contents-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .contents-table th,
        .contents-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #e2e8f0;
        }

        .contents-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }

        .contents-table input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
        }

        .add-item-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-item-btn:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* Filter Styles */
        .filter-section {
            background: white;
            padding: 20px 24px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
            min-width: 80px;
        }

        .filter-select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            flex: 1;
        }

        .beneficiaries-preview {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .preview-count {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .preview-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .beneficiary-item {
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: #f8fafc;
        }

        .action-btn.edit {
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .action-btn.delete {
            color: #ef4444;
            border-color: #ef4444;
        }

        .action-btn.view {
            color: #10b981;
            border-color: #10b981;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f1f5f9;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }

        .modal-close:hover {
            background: #e2e8f0;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: flex;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-right: 0;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .content-area {
                padding: 16px;
            }
            
            .header {
                padding: 12px 16px;
            }

            .search-container {
                margin: 0 12px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .package-type-selector {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                min-width: auto;
            }
        }

        /* Map Styles */
        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-control-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .map-control-btn:hover {
            background: #f8fafc;
        }

        .map-control-btn.active {
            background: #3b82f6;
            color: white;
        }

        .map-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Notifications Styles */
        .notifications-bar {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notifications-bar.critical {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .notifications-bar.success {
            background: #dcfce7;
            border-color: #10b981;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .notification-icon {
            width: 20px;
            height: 20px;
        }

        .notification-text {
            font-size: 14px;
            font-weight: 500;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        .notification-btn {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .notification-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .notification-btn.secondary {
            background: transparent;
            color: #64748b;
            border-color: #e2e8f0;
        }

        /* Import Section Styles */
        .import-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-section:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .import-section.dragover {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .import-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: #64748b;
        }

        .import-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .import-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 16px;
        }

        .import-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Delivery Details Modal */
        .delivery-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-section {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .detail-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .detail-label {
            color: #64748b;
        }

        .detail-value {
            color: #1e293b;
            font-weight: 500;
        }

        .delivery-history {
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .history-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .history-content {
            flex: 1;
        }

        .history-title {
            font-weight: 500;
            color: #1e293b;
            font-size: 13px;
        }

        .history-subtitle {
            font-size: 11px;
            color: #64748b;
            margin-top: 2px;
        }

        .history-date {
            font-size: 11px;
            color: #94a3b8;
        }

        /* Table Sorting Styles */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-left: 20px !important;
        }

        .sortable-header:hover {
            background: #e2e8f0;
        }

        .sort-arrow {
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: #94a3b8;
        }

        .sort-arrow.asc::after {
            content: "▲";
            color: #3b82f6;
        }

        .sort-arrow.desc::after {
            content: "▼";
            color: #3b82f6;
        }

        .sort-arrow.none::after {
            content: "▲▼";
        }

        /* Institution Selection Styles - Improved */
        .institution-search {
            position: relative;
            margin-bottom: 16px;
        }

        .institution-search-input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            background: white;
        }

        .institution-search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .institution-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            width: 18px;
            height: 18px;
        }

        .popular-institutions {
            margin-bottom: 20px;
        }

        .popular-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .popular-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .popular-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: white;
            color: #374151;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .popular-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .popular-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .all-institutions {
            margin-top: 20px;
        }

        .institutions-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
        }

        .institution-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .institution-item:last-child {
            border-bottom: none;
        }

        .institution-item:hover {
            background: #f9fafb;
        }

        .institution-item.selected {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        .institution-info {
            flex: 1;
        }

        .institution-name-small {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .institution-stats-small {
            font-size: 12px;
            color: #6b7280;
        }

        .institution-check {
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            position: relative;
            transition: all 0.2s ease;
        }

        .institution-item.selected .institution-check {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .institution-item.selected .institution-check::after {
            content: "✓";
            position: absolute;
            top: -2px;
            left: 1px;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        /* Template View Modal */
        .template-contents {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .content-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .content-name {
            font-weight: 500;
            color: #374151;
        }

        .content-details {
            font-size: 12px;
            color: #6b7280;
        }

        /* Beneficiary Search Improvements */
        .beneficiary-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background: #f9fafb;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-name {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .result-details {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .templates-filtered {
            display: none;
        }

        .templates-filtered.active {
            display: block;
        }

        /* Reschedule Modal */
        .reschedule-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .reschedule-option {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .reschedule-option:hover {
            border-color: #3b82f6;
        }

        .reschedule-option.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .reschedule-option-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .reschedule-option-desc {
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">
                    <i data-feather="heart"></i>
                </div>
                <div class="logo-text">نظام المساعدات</div>
            </div>

            <div class="menu-section">
                <div class="menu-title">القوائم الرئيسية</div>
                </div>

                <div class="menu-item">
                    <div class="menu-link active" onclick="toggleSubmenu(this)">
                        <i data-feather="package" class="menu-icon"></i>
                        <span class="menu-text">إدارة الطرود</span>
                        <i data-feather="chevron-down" class="menu-arrow"></i>
                    </div>
                    <div class="submenu" style="max-height: 400px;">
                        <a href="#" class="submenu-link active" onclick="showPage('package-templates')">قوالب الطرود</a>
                        <a href="#" class="submenu-link" onclick="showPage('bulk-send')">إرسال طرد جماعي</a>
                        <a href="#" class="submenu-link" onclick="showPage('individual-send')">إرسال طرد فردي</a>
                        <a href="#" class="submenu-link" onclick="showPage('package-tracking')">تتبع الإرسالات</a>
                        <a href="#" class="submenu-link" onclick="showPage('distribution-reports')">تقارير التوزيع</a>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Template View Modal -->
        <div id="templateViewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل القالب</h3>
                    <button class="modal-close" onclick="closeModal('templateViewModal')">
                        <i data-feather="x"></i>
                    </button>
                </div>
                
                <div class="delivery-details">
                    <div class="detail-section">
                        <div class="detail-title">معلومات القالب</div>
                        <div class="detail-item">
                            <span class="detail-label">معرف القالب:</span>
                            <span class="detail-value" id="viewTemplateId">TEMP-001</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">اسم القالب:</span>
                            <span class="detail-value" id="viewTemplateName">طرد رمضان كريم 2024</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">نوع الطرد:</span>
                            <span class="detail-value" id="viewTemplateType">غذائي</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">المؤسسة المانحة:</span>
                            <span class="detail-value" id="viewTemplateInstitution">الأونروا</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">الحالة:</span>
                            <span class="detail-value" id="viewTemplateStatus">نشط</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-title">إحصائيات الاستخدام</div>
                        <div class="detail-item">
                            <span class="detail-label">عدد مرات الاستخدام:</span>
                            <span class="detail-value">247 مرة</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">آخر استخدام:</span>
                            <span class="detail-value">15/01/2024</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">الوزن الإجمالي:</span>
                            <span class="detail-value" id="viewTemplateTotalWeight">18.6 كيلو</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">عدد الأصناف:</span>
                            <span class="detail-value" id="viewTemplateItemsCount">8 أصناف</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-title">محتويات الطرد</div>
                    <div class="template-contents" id="viewTemplateContents">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="editTemplateFromView()">
                        <i data-feather="edit"></i>
                        تعديل القالب
                    </button>
                    <button type="button" class="btn" onclick="duplicateTemplateFromView()">
                        <i data-feather="copy"></i>
                        نسخ القالب
                    </button>
                    <button type="button" class="btn btn-primary" onclick="useTemplateFromView()">
                        <i data-feather="send"></i>
                        استخدام القالب
                    </button>
                </div>
            </div>
        </div>

        <!-- Preview Send Modal -->
        <div id="previewSendModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">معاينة الإرسال الجماعي</h3>
                    <button class="modal-close" onclick="closeModal('previewSendModal')">
                        <i data-feather="x"></i>
                    </button>
                </div>
                
                <div class="delivery-details">
                    <div class="detail-section">
                        <div class="detail-title">تفاصيل الإرسال</div>
                        <div class="detail-item">
                            <span class="detail-label">المؤسسة المانحة:</span>
                            <span class="detail-value" id="previewInstitution">الأونروا</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">قالب الطرد:</span>
                            <span class="detail-value" id="previewTemplate">طرد رمضان كريم 2024</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">عدد المستفيدين:</span>
                            <span class="detail-value" id="previewBeneficiariesCount">156 مستفيد</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">التكلفة المتوقعة:</span>
                            <span class="detail-value" id="previewCost">$12,450</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-title">الفلاتر المطبقة</div>
                        <div id="previewFilters">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <div class="detail-title">عينة من المستفيدين (أول 10)</div>
                    <div id="previewBeneficiariesList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal('previewSendModal')">
                        <i data-feather="arrow-right"></i>
                        العودة للتعديل
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmSendFromPreview()">
                        <i data-feather="send"></i>
                        تأكيد الإرسال النهائي
                    </button>
                </div>
            </div>
        </div>

        <!-- Delivery Details Modal -->
        <div id="deliveryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الإرسالية</h3>
                    <button class="modal-close" onclick="closeModal('deliveryModal')">
                        <i data-feather="x"></i>
                    </button>
                </div>
                
                <div class="delivery-details">
                    <div class="detail-section">
                        <div class="detail-title">معلومات الإرسالية</div>
                        <div class="detail-item">
                            <span class="detail-label">رقم الإرسالية:</span>
                            <span class="detail-value" id="deliveryId">SEND-2024-001</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">نوع الطرد:</span>
                            <span class="detail-value" id="packageType">طرد رمضان كريم 2024</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">المستفيد:</span>
                            <span class="detail-value" id="beneficiaryName">أحمد محمد الخالدي</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">المندوب:</span>
                            <span class="detail-value" id="deliveryAgent">خالد أحمد</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <div class="detail-title">تفاصيل التوصيل</div>
                        <div class="detail-item">
                            <span class="detail-label">وقت التوصيل:</span>
                            <span class="detail-value" id="deliveryTime">14:30 - 15/01/2024</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">رقم الهاتف:</span>
                            <span class="detail-value" id="beneficiaryPhone">0597123456</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">العنوان:</span>
                            <span class="detail-value" id="beneficiaryAddress">حي الشجاعية، شارع صلاح الدين</span>
                        </div>
                    </div>
                </div>

                <div class="delivery-history">
                    <div class="history-item">
                        <div class="history-icon" style="background: #10b981;">
                            <i data-feather="check"></i>
                        </div>
                        <div class="history-content">
                            <div class="history-title">تم التوصيل بنجاح</div>
                            <div class="history-subtitle">استلم المستفيد الطرد وتم توقيع الاستلام</div>
                        </div>
                        <div class="history-date">14:30</div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-icon" style="background: #3b82f6;">
                            <i data-feather="truck"></i>
                        </div>
                        <div class="history-content">
                            <div class="history-title">في الطريق للمستفيد</div>
                            <div class="history-subtitle">المندوب في طريقه لعنوان المستفيد</div>
                        </div>
                        <div class="history-date">13:45</div>
                    </div>
                    
                    <div class="history-item">
                        <div class="history-icon" style="background: #f59e0b;">
                            <i data-feather="package"></i>
                        </div>
                        <div class="history-content">
                            <div class="history-title">تم التحضير</div>
                            <div class="history-subtitle">تم تحضير الطرد وتسليمه للمندوب</div>
                        </div>
                        <div class="history-date">10:20</div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="printDeliveryReport()">
                        <i data-feather="printer"></i>
                        طباعة التقرير
                    </button>
                    <button type="button" class="btn btn-primary" onclick="closeModal('deliveryModal')">
                        <i data-feather="x"></i>
                        إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- Reschedule Modal -->
        <div id="rescheduleModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">إعادة جدولة التوصيل</h3>
                    <button class="modal-close" onclick="closeModal('rescheduleModal')">
                        <i data-feather="x"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">سبب إعادة الجدولة</label>
                    <div class="reschedule-options">
                        <div class="reschedule-option" onclick="selectRescheduleReason(this, 'not-found')">
                            <div class="reschedule-option-title">لم يتم العثور على المستفيد</div>
                            <div class="reschedule-option-desc">العنوان غير صحيح أو المستفيد غير متواجد</div>
                        </div>
                        <div class="reschedule-option" onclick="selectRescheduleReason(this, 'refused')">
                            <div class="reschedule-option-title">رفض الاستلام</div>
                            <div class="reschedule-option-desc">المستفيد رفض استلام الطرد</div>
                        </div>
                        <div class="reschedule-option" onclick="selectRescheduleReason(this, 'security')">
                            <div class="reschedule-option-title">أسباب أمنية</div>
                            <div class="reschedule-option-desc">منطقة غير آمنة للتوصيل</div>
                        </div>
                        <div class="reschedule-option" onclick="selectRescheduleReason(this, 'other')">
                            <div class="reschedule-option-title">أسباب أخرى</div>
                            <div class="reschedule-option-desc">سبب غير مذكور أعلاه</div>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">تاريخ إعادة التوصيل</label>
                        <input type="date" class="form-input" id="rescheduleDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">وقت إعادة التوصيل</label>
                        <input type="time" class="form-input" id="rescheduleTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">مندوب بديل (اختياري)</label>
                    <select class="form-select" id="alternativeAgent">
                        <option value="">نفس المندوب</option>
                        <option value="agent-2">محمد سعيد</option>
                        <option value="agent-3">أحمد علي</option>
                        <option value="agent-4">يوسف حسام</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ملاحظات إضافية</label>
                    <textarea class="form-textarea" placeholder="أي ملاحظات أو تعليمات خاصة..."></textarea>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal('rescheduleModal')">
                        <i data-feather="x"></i>
                        إلغاء
                    </button>
                    <button type="button" class="btn btn-primary" onclick="confirmReschedule()">
                        <i data-feather="calendar"></i>
                        تأكيد إعادة الجدولة
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Notifications Container -->
            <div id="notificationsContainer"></div>
            
            <!-- Header -->
            <div class="header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">
                        <i data-feather="menu"></i>
                    </button>
                    
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="البحث عن قوالب الطرود...">
                        <i data-feather="search" class="search-icon"></i>
                    </div>
                </div>
                
                <div class="header-actions">
                    <button class="theme-btn">
                        <i data-feather="moon"></i>
                    </button>
                    <button class="notification-btn" style="position: relative;">
                        <i data-feather="bell"></i>
                        <span class="notification-badge">5</span>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar">م</div>
                        <div class="user-info">
                            <h4>محمد أحمد</h4>
                            <p>مدير النظام</p>
                        </div>
                        <i data-feather="chevron-down" style="width: 16px; height: 16px; color: #94a3b8;"></i>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard" class="page-content">
                <div class="content-area">
                    <div class="page-header">
                        <div class="breadcrumb">
                            <span class="breadcrumb-item">الرئيسية</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item active">لوحة التحكم</span>
                        </div>
                        <h1 class="page-title">لوحة التحكم</h1>
                        <p class="page-subtitle">نظرة عامة على أنشطة المساعدات الإنسانية</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: #10b981;">
                                <i data-feather="layers"></i>
                            </div>
                            <div class="stat-info">
                                <h3>24</h3>
                                <p>قوالب طرود نشطة</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +3 هذا الشهر
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #3b82f6;">
                                <i data-feather="send"></i>
                            </div>
                            <div class="stat-info">
                                <h3>1,567</h3>
                                <p>طرود تم إرسالها</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +12% هذا الأسبوع
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #f59e0b;">
                                <i data-feather="users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>3,782</h3>
                                <p>مستفيدين مستهدفين</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +89 جديد
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #8b5cf6;">
                                <i data-feather="check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>94.2%</h3>
                                <p>معدل نجاح التوزيع</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +2.1% تحسن
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="form-grid">
                        <div class="stat-card" onclick="showPage('package-templates')" style="cursor: pointer;">
                            <div class="stat-icon" style="background: #3b82f6;">
                                <i data-feather="plus"></i>
                            </div>
                            <div class="stat-info">
                                <h3 style="font-size: 18px;">إنشاء قالب طرد</h3>
                                <p>إنشاء قالب جديد للطرود</p>
                            </div>
                        </div>

                        <div class="stat-card" onclick="showPage('bulk-send')" style="cursor: pointer;">
                            <div class="stat-icon" style="background: #10b981;">
                                <i data-feather="send"></i>
                            </div>
                            <div class="stat-info">
                                <h3 style="font-size: 18px;">إرسال جماعي</h3>
                                <p>إرسال طرود لمجموعة مستفيدين</p>
                            </div>
                        </div>

                        <div class="stat-card" onclick="showPage('package-tracking')" style="cursor: pointer;">
                            <div class="stat-icon" style="background: #8b5cf6;">
                                <i data-feather="truck"></i>
                            </div>
                            <div class="stat-info">
                                <h3 style="font-size: 18px;">تتبع الإرسالات</h3>
                                <p>متابعة حالة الطرود المرسلة</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Package Templates Page -->
            <div id="package-templates" class="page-content active">
                <div class="content-area">
                    <div class="page-header">
                        <div class="breadcrumb">
                            <span class="breadcrumb-item">الرئيسية</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item">إدارة الطرود</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item active">قوالب الطرود</span>
                        </div>
                        <h1 class="page-title">قوالب الطرود</h1>
                        <p class="page-subtitle">إنشاء وإدارة قوالب الطرود العامة</p>
                    </div>

                    <!-- Action Bar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select class="form-select" style="width: 150px;">
                                <option value="">جميع الأنواع</option>
                                <option value="food">غذائي</option>
                                <option value="medical">طبي</option>
                                <option value="clothing">ملابس</option>
                                <option value="blankets">بطانيات</option>
                            </select>
                            <select class="form-select" style="width: 150px;">
                                <option value="">جميع الحالات</option>
                                <option value="active">نشط</option>
                                <option value="draft">مسودة</option>
                                <option value="inactive">غير نشط</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="openTemplateModal()">
                            <i data-feather="plus"></i>
                            إنشاء قالب جديد
                        </button>
                    </div>

                    <!-- Templates Table -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">قوالب الطرود</h3>
                            <div class="table-actions">
                                <button class="btn">
                                    <i data-feather="download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>معرف القالب</th>
                                    <th>اسم القالب</th>
                                    <th>النوع</th>
                                    <th>المؤسسة المانحة</th>
                                    <th>عدد الأصناف</th>
                                    <th>الحالة</th>
                                    <th>تاريخ الإنشاء</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>TEMP-001</strong></td>
                                    <td>طرد رمضان كريم 2024</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i data-feather="package" style="width: 16px; height: 16px; color: #f59e0b;"></i>
                                            غذائي
                                        </div>
                                    </td>
                                    <td>الأونروا</td>
                                    <td>8 أصناف</td>
                                    <td><span class="status-badge status-active">نشط</span></td>
                                    <td>2024-01-10</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn view" onclick="viewTemplate('TEMP-001')">
                                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn edit" onclick="editTemplate('TEMP-001')">
                                                <i data-feather="edit" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="duplicateTemplate('TEMP-001')" style="color: #8b5cf6; border-color: #8b5cf6;">
                                                <i data-feather="copy" style="width: 12px; height: 12px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>TEMP-002</strong></td>
                                    <td>طرد الشتاء الدافئ</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i data-feather="layers" style="width: 16px; height: 16px; color: #06b6d4;"></i>
                                            ملابس
                                        </div>
                                    </td>
                                    <td>الهلال الأحمر</td>
                                    <td>6 أصناف</td>
                                    <td><span class="status-badge status-active">نشط</span></td>
                                    <td>2024-01-08</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn view" onclick="viewTemplate('TEMP-002')">
                                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn edit" onclick="editTemplate('TEMP-002')">
                                                <i data-feather="edit" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="duplicateTemplate('TEMP-002')" style="color: #8b5cf6; border-color: #8b5cf6;">
                                                <i data-feather="copy" style="width: 12px; height: 12px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>TEMP-003</strong></td>
                                    <td>طرد الإسعافات الأولية</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i data-feather="heart" style="width: 16px; height: 16px; color: #ef4444;"></i>
                                            طبي
                                        </div>
                                    </td>
                                    <td>منظمة الصحة العالمية</td>
                                    <td>12 صنف</td>
                                    <td><span class="status-badge status-draft">مسودة</span></td>
                                    <td>2024-01-12</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn view" onclick="viewTemplate('TEMP-003')">
                                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn edit" onclick="editTemplate('TEMP-003')">
                                                <i data-feather="edit" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn delete" onclick="deleteTemplate('TEMP-003')">
                                                <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bulk Send Page -->
            <div id="bulk-send" class="page-content">
                <div class="content-area">
                    <div class="page-header">
                        <div class="breadcrumb">
                            <span class="breadcrumb-item">الرئيسية</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item">إدارة الطرود</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item active">إرسال طرد جماعي</span>
                        </div>
                        <h1 class="page-title">إرسال طرد جماعي</h1>
                        <p class="page-subtitle">إرسال طرود لمجموعة مستفيدين بناءً على فلاتر محددة</p>
                    </div>

                    <!-- Institution Selection -->
                    <div class="form-card">
                        <h3 class="form-card-title">اختيار المؤسسة المانحة</h3>
                        
                        <!-- Search Bar -->
                        <div class="institution-search">
                            <input type="text" class="institution-search-input" id="institutionSearch" placeholder="ابحث عن المؤسسة..." onkeyup="filterInstitutions()">
                            <i data-feather="search" class="institution-search-icon"></i>
                        </div>

                        <!-- Popular Institutions -->
                        <div class="popular-institutions">
                            <div class="popular-title">
                                <i data-feather="star" style="width: 16px; height: 16px; color: #f59e0b;"></i>
                                المؤسسات الأكثر استخداماً
                            </div>
                            <div class="popular-buttons">
                                <button class="popular-btn" onclick="selectInstitutionQuick('unrwa', this)">الأونروا</button>
                                <button class="popular-btn" onclick="selectInstitutionQuick('red-crescent', this)">الهلال الأحمر</button>
                                <button class="popular-btn" onclick="selectInstitutionQuick('wfp', this)">برنامج الغذاء العالمي</button>
                                <button class="popular-btn" onclick="selectInstitutionQuick('who', this)">منظمة الصحة العالمية</button>
                            </div>
                        </div>

                        <!-- All Institutions -->
                        <div class="all-institutions">
                            <div class="popular-title">جميع المؤسسات</div>
                            <div class="institutions-list" id="institutionsList">
                                <div class="institution-item" data-institution="unrwa" onclick="selectInstitutionFromList('unrwa', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">الأونروا</div>
                                        <div class="institution-stats-small">347 طرد متاح • 8 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>
                                
                                <div class="institution-item" data-institution="wfp" onclick="selectInstitutionFromList('wfp', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">برنامج الغذاء العالمي</div>
                                        <div class="institution-stats-small">234 طرد متاح • 5 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>

                                <div class="institution-item" data-institution="red-crescent" onclick="selectInstitutionFromList('red-crescent', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">الهلال الأحمر الفلسطيني</div>
                                        <div class="institution-stats-small">189 طرد متاح • 6 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>

                                <div class="institution-item" data-institution="who" onclick="selectInstitutionFromList('who', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">منظمة الصحة العالمية</div>
                                        <div class="institution-stats-small">95 طرد متاح • 4 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>

                                <div class="institution-item" data-institution="unicef" onclick="selectInstitutionFromList('unicef', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">اليونيسف</div>
                                        <div class="institution-stats-small">156 طرد متاح • 7 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>

                                <div class="institution-item" data-institution="unesco" onclick="selectInstitutionFromList('unesco', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">منظمة اليونسكو</div>
                                        <div class="institution-stats-small">78 طرد متاح • 3 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>

                                <div class="institution-item" data-institution="qatar-charity" onclick="selectInstitutionFromList('qatar-charity', this)">
                                    <div class="institution-info">
                                        <div class="institution-name-small">مؤسسة قطر الخيرية</div>
                                        <div class="institution-stats-small">45 طرد متاح • 2 قوالب</div>
                                    </div>
                                    <div class="institution-check"></div>
                                </div>
                            </div>
                        </div>
                        
                        <input type="hidden" id="selectedInstitution" required>
                    </div>

                    <!-- Template Selection (will be shown after institution selection) -->
                    <div class="form-card templates-filtered" id="templatesSection">
                        <h3 class="form-card-title">اختيار قالب الطرد</h3>
                        <div id="institutionTemplates"></div>
                        <input type="hidden" id="selectedTemplate" required>
                    </div>

                    <!-- Import Beneficiaries Section -->
                    <div class="form-card">
                        <h3 class="form-card-title">استيراد مستفيدين جدد</h3>
                        
                        <div class="import-section" onclick="document.getElementById('beneficiariesFile').click()">
                            <i data-feather="upload" class="import-icon"></i>
                            <div class="import-title">استيراد قائمة مستفيدين من ملف Excel</div>
                            <div class="import-subtitle">اسحب الملف هنا أو اضغط للاختيار (xlsx, xls, csv)</div>
                            <div class="import-actions">
                                <button type="button" class="btn btn-primary">
                                    <i data-feather="upload"></i>
                                    اختيار ملف
                                </button>
                                <button type="button" class="btn" onclick="downloadTemplate()">
                                    <i data-feather="download"></i>
                                    تحميل قالب جاهز
                                </button>
                            </div>
                            <input type="file" id="beneficiariesFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileImport(this)">
                        </div>

                        <!-- Real Example Button - Outside import area -->
                        <div style="text-align: center; margin-top: 16px;">
                            <button type="button" class="btn" onclick="showRealExample()" style="background: #10b981; color: white; border-color: #10b981;">
                                <i data-feather="eye"></i>
                                رؤية مثال حقيقي للاستيراد
                            </button>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                سيتم إضافة 5 مستفيدين تجريبيين لرؤية كيفية عمل النظام
                            </div>
                        </div>

                        <!-- Import Results -->
                        <div id="importResults" style="display: none;">
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 16px; margin-top: 16px;">
                                <h4 style="color: #1e40af; margin-bottom: 8px;">نتائج الاستيراد:</h4>
                                <div id="importSummary"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Beneficiaries Filters -->
                    <div class="form-card">
                        <h3 class="form-card-title">فلاتر المستفيدين</h3>
                        
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">حالة الاستفادة:</label>
                                <select class="filter-select" id="benefitStatus" onchange="updateBeneficiariesPreview()">
                                    <option value="">جميع الحالات</option>
                                    <option value="never">لم يستفيدوا مطلقاً</option>
                                    <option value="recent">استفادوا مؤخراً</option>
                                    <option value="old">لم يستفيدوا منذ فترة</option>
                                    <option value="new-imported">المستفيدين الجدد المستوردين</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">حجم الأسرة:</label>
                                <select class="filter-select" id="familySize" onchange="updateBeneficiariesPreview()">
                                    <option value="">جميع الأحجام</option>
                                    <option value="small">أقل من 5 أشخاص</option>
                                    <option value="medium">5-10 أشخاص</option>
                                    <option value="large">أكبر من 10 أشخاص</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">وجود أطفال:</label>
                                <select class="filter-select" id="hasChildren" onchange="updateBeneficiariesPreview()">
                                    <option value="">غير محدد</option>
                                    <option value="yes">لديهم أطفال</option>
                                    <option value="no">لا يوجد أطفال</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-label">تاريخ الإضافة:</label>
                                <select class="filter-select" id="dateAdded" onchange="updateBeneficiariesPreview()">
                                    <option value="">جميع التواريخ</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                </select>
                            </div>
                        </div>

                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">كبار السن:</label>
                                <select class="filter-select" id="hasElderly" onchange="updateBeneficiariesPreview()">
                                    <option value="">غير محدد</option>
                                    <option value="yes">يوجد كبار سن</option>
                                    <option value="no">لا يوجد كبار سن</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">المنطقة:</label>
                                <select class="filter-select" id="area" onchange="updateBeneficiariesPreview()">
                                    <option value="">جميع المناطق</option>
                                    <option value="north">شمال غزة</option>
                                    <option value="gaza">مدينة غزة</option>
                                    <option value="middle">الوسط</option>
                                    <option value="khan-younis">خان يونس</option>
                                    <option value="rafah">رفح</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">آخر استلام:</label>
                                <select class="filter-select" id="lastReceived" onchange="updateBeneficiariesPreview()">
                                    <option value="">غير محدد</option>
                                    <option value="week">خلال أسبوع</option>
                                    <option value="month">خلال شهر</option>
                                    <option value="quarter">خلال 3 أشهر</option>
                                    <option value="never">لم يستلم أبداً</option>
                                </select>
                            </div>
                        </div>

                        <!-- Beneficiaries Preview -->
                        <div class="beneficiaries-preview">
                            <div class="preview-count" id="beneficiariesCount">عدد المستفيدين المطابقين: 0</div>
                            <div class="preview-list" id="beneficiariesList">
                                <div style="text-align: center; color: #94a3b8; padding: 20px;">
                                    يرجى اختيار الفلاتر لعرض المستفيدين المطابقين
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Send Actions -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn" onclick="showPage('package-templates')">
                            <i data-feather="arrow-right"></i>
                            العودة
                        </button>
                        <button type="button" class="btn" onclick="previewSending()">
                            <i data-feather="eye"></i>
                            معاينة الإرسال
                        </button>
                        <button type="button" class="btn btn-primary" onclick="confirmBulkSend()">
                            <i data-feather="send"></i>
                            تأكيد الإرسال
                        </button>
                    </div>
                </div>
            </div>

            <!-- Individual Send Page -->
            <div id="individual-send" class="page-content">
                <div class="content-area">
                    <div class="page-header">
                        <div class="breadcrumb">
                            <span class="breadcrumb-item">الرئيسية</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item">إدارة الطرود</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item active">إرسال طرد فردي</span>
                        </div>
                        <h1 class="page-title">إرسال طرد فردي</h1>
                        <p class="page-subtitle">إرسال طرد مخصص لمستفيد واحد للحالات الخاصة</p>
                    </div>

                    <!-- Template Selection -->
                    <div class="form-card">
                        <h3 class="form-card-title">اختيار قالب الطرد</h3>
                        <select class="form-select" id="individualTemplate" style="margin-bottom: 16px;">
                            <option value="">اختر قالب الطرد</option>
                            <option value="TEMP-001">طرد رمضان كريم 2024 - الأونروا (غذائي)</option>
                            <option value="TEMP-006">طرد الأونروا الغذائي الأساسي - الأونروا (غذائي)</option>
                            <option value="TEMP-007">طرد الأونروا للعائلات الكبيرة - الأونروا (غذائي)</option>
                            <option value="TEMP-002">طرد الشتاء الدافئ - الهلال الأحمر (ملابس)</option>
                            <option value="TEMP-003">طرد الإسعافات الأولية - منظمة الصحة العالمية (طبي)</option>
                            <option value="TEMP-004">طرد غذائي للأطفال - اليونيسف (غذائي)</option>
                            <option value="TEMP-005">طرد غذائي أساسي - برنامج الغذاء العالمي (غذائي)</option>
                        </select>
                        
                        <div id="templateDetails" style="display: none; background: #f8fafc; padding: 16px; border-radius: 8px;">
                            <h4 style="margin-bottom: 8px; color: #1e293b;">تفاصيل القالب:</h4>
                            <div id="templateInfo"></div>
                        </div>
                    </div>

                    <!-- Beneficiary Selection -->
                    <div class="form-card">
                        <h3 class="form-card-title">اختيار المستفيد</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">البحث عن المستفيد</label>
                                <div style="position: relative;">
                                    <input type="text" class="form-input" id="beneficiarySearch" placeholder="ابحث بالاسم أو رقم الهوية..." onkeyup="searchBeneficiaryLive()" onfocus="showSearchResults()" onblur="hideSearchResults()">
                                    <div class="beneficiary-search-results" id="searchResults"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">أو اختر من القائمة</label>
                                <select class="form-select" id="beneficiarySelect">
                                    <option value="">اختر المستفيد</option>
                                    <option value="BEN-001">أحمد محمد الخالدي - 900123456</option>
                                    <option value="BEN-002">فاطمة سالم النجار - 900234567</option>
                                    <option value="BEN-003">محمود عبد الله زقوت - 900345678</option>
                                    <option value="BEN-004">مريم إبراهيم شعت - 900456789</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="beneficiaryDetails" style="display: none; background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <h4 style="margin-bottom: 8px; color: #1e293b;">معلومات المستفيد:</h4>
                            <div id="beneficiaryInfo"></div>
                        </div>
                    </div>

                    <!-- Special Instructions -->
                    <div class="form-card">
                        <h3 class="form-card-title">تعليمات خاصة</h3>
                        <div class="form-group">
                            <label class="form-label">سبب الإرسال الفردي</label>
                            <select class="form-select">
                                <option value="">اختر السبب</option>
                                <option value="emergency">حالة طوارئ</option>
                                <option value="special-needs">احتياجات خاصة</option>
                                <option value="compensation">تعويض عن طرد مفقود</option>
                                <option value="medical">حالة طبية خاصة</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ملاحظات إضافية</label>
                            <textarea class="form-textarea" placeholder="أي ملاحظات أو تعليمات خاصة للمندوب..."></textarea>
                        </div>
                    </div>

                    <!-- Send Actions -->
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn" onclick="showPage('package-templates')">
                            <i data-feather="arrow-right"></i>
                            العودة
                        </button>
                        <button type="button" class="btn btn-primary" onclick="confirmIndividualSend()">
                            <i data-feather="send"></i>
                            إرسال الطرد
                        </button>
                    </div>
                </div>
            </div>

            <!-- Package Tracking Page -->
            <div id="package-tracking" class="page-content">
                <div class="content-area">
                    <div class="page-header">
                        <div class="breadcrumb">
                            <span class="breadcrumb-item">الرئيسية</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item">إدارة الطرود</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item active">تتبع الإرسالات</span>
                        </div>
                        <h1 class="page-title">تتبع الإرسالات</h1>
                        <p class="page-subtitle">متابعة حالة جميع الطرود المرسلة</p>
                    </div>

                    <!-- Tracking Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: #10b981;">
                                <i data-feather="check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>1,247</h3>
                                <p>طرود تم توصيلها</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +156 اليوم
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #3b82f6;">
                                <i data-feather="truck"></i>
                            </div>
                            <div class="stat-info">
                                <h3>89</h3>
                                <p>طرود في الطريق</p>
                                <div class="stat-change positive">
                                    <i data-feather="clock" style="width: 14px; height: 14px;"></i>
                                    متوسط 2.4 ساعة
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #f59e0b;">
                                <i data-feather="package"></i>
                            </div>
                            <div class="stat-info">
                                <h3>156</h3>
                                <p>طرود قيد التحضير</p>
                                <div class="stat-change positive">
                                    <i data-feather="clock" style="width: 14px; height: 14px;"></i>
                                    متوسط 4 ساعات
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #ef4444;">
                                <i data-feather="alert-circle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>12</h3>
                                <p>طرود تحتاج متابعة</p>
                                <div class="stat-change negative">
                                    <i data-feather="alert-triangle" style="width: 14px; height: 14px;"></i>
                                    يحتاج إجراء
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Map -->
                    <div class="form-card">
                        <h3 class="form-card-title">الخريطة التفاعلية - التتبع الجغرافي الحي</h3>
                        <div class="map-container">
                            <div id="trackingMap"></div>
                            
                            <!-- Map Controls -->
                            <div class="map-controls">
                                <button class="map-control-btn active" onclick="toggleMapLayer('all')" id="layerAll">
                                    <i data-feather="eye"></i>
                                    جميع الحالات
                                </button>
                                <button class="map-control-btn" onclick="toggleMapLayer('delivered')" id="layerDelivered">
                                    <i data-feather="check-circle"></i>
                                    تم التوصيل
                                </button>
                                <button class="map-control-btn" onclick="toggleMapLayer('in-progress')" id="layerInProgress">
                                    <i data-feather="truck"></i>
                                    قيد التوزيع
                                </button>
                                <button class="map-control-btn" onclick="toggleMapLayer('failed')" id="layerFailed">
                                    <i data-feather="x-circle"></i>
                                    فشل التسليم
                                </button>
                            </div>

                            <!-- Map Legend -->
                            <div class="map-legend">
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #10b981;"></span>
                                    <span>تم التوصيل</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #3b82f6;"></span>
                                    <span>قيد التوزيع</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #f59e0b;"></span>
                                    <span>قيد التحضير</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #ef4444;"></span>
                                    <span>فشل التسليم</span>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot" style="background: #8b5cf6;"></span>
                                    <span>متأخر</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tracking Table -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">متابعة الطرود</h3>
                            <div class="table-actions">
                                <button class="btn">
                                    <i data-feather="filter"></i>
                                    فلتر
                                </button>
                                <button class="btn btn-primary">
                                    <i data-feather="refresh-cw"></i>
                                    تحديث
                                </button>
                            </div>
                        </div>
                        
                        <table class="data-table" id="trackingTable">
                            <thead>
                                <tr>
                                    <th class="sortable-header" onclick="sortTable(0)">
                                        رقم الإرسالية
                                        <span class="sort-arrow none" id="sort-0"></span>
                                    </th>
                                    <th class="sortable-header" onclick="sortTable(1)">
                                        قالب الطرد
                                        <span class="sort-arrow none" id="sort-1"></span>
                                    </th>
                                    <th class="sortable-header" onclick="sortTable(2)">
                                        المستفيد
                                        <span class="sort-arrow none" id="sort-2"></span>
                                    </th>
                                    <th class="sortable-header" onclick="sortTable(3)">
                                        نوع الإرسال
                                        <span class="sort-arrow none" id="sort-3"></span>
                                    </th>
                                    <th class="sortable-header" onclick="sortTable(4)">
                                        المندوب
                                        <span class="sort-arrow none" id="sort-4"></span>
                                    </th>
                                    <th class="sortable-header" onclick="sortTable(5)">
                                        الحالة
                                        <span class="sort-arrow none" id="sort-5"></span>
                                    </th>
                                    <th class="sortable-header" onclick="sortTable(6)">
                                        تاريخ الإرسال
                                        <span class="sort-arrow none" id="sort-6"></span>
                                    </th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>SEND-2024-001</strong></td>
                                    <td>طرد رمضان كريم 2024</td>
                                    <td>أحمد محمد الخالدي</td>
                                    <td>
                                        <span style="background: #eff6ff; color: #3b82f6; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            فردي
                                        </span>
                                    </td>
                                    <td>خالد أحمد</td>
                                    <td><span class="status-badge status-active">تم التوصيل</span></td>
                                    <td>2024-01-15</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn view" onclick="viewDelivery('SEND-2024-001')">
                                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="trackDelivery('SEND-2024-001')" style="color: #10b981; border-color: #10b981;">
                                                <i data-feather="map-pin" style="width: 12px; height: 12px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>SEND-2024-002</strong></td>
                                    <td>طرد الشتاء الدافئ</td>
                                    <td>23 مستفيد</td>
                                    <td>
                                        <span style="background: #ecfdf5; color: #10b981; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            جماعي
                                        </span>
                                    </td>
                                    <td>محمد سعيد + 3</td>
                                    <td><span class="status-badge status-pending">قيد التوزيع</span></td>
                                    <td>2024-01-15</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn view" onclick="viewDelivery('SEND-2024-002')">
                                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="trackDelivery('SEND-2024-002')" style="color: #10b981; border-color: #10b981;">
                                                <i data-feather="map-pin" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="rescheduleDelivery('SEND-2024-002')" style="color: #f59e0b; border-color: #f59e0b;">
                                                <i data-feather="calendar" style="width: 12px; height: 12px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>SEND-2024-003</strong></td>
                                    <td>طرد الإسعافات الأولية</td>
                                    <td>فاطمة سالم النجار</td>
                                    <td>
                                        <span style="background: #eff6ff; color: #3b82f6; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            فردي
                                        </span>
                                    </td>
                                    <td>أحمد علي</td>
                                    <td><span class="status-badge" style="background: #fee2e2; color: #dc2626;">فشل التسليم</span></td>
                                    <td>2024-01-14</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn view" onclick="viewDelivery('SEND-2024-003')">
                                                <i data-feather="eye" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="rescheduleDelivery('SEND-2024-003')" style="color: #f59e0b; border-color: #f59e0b;">
                                                <i data-feather="calendar" style="width: 12px; height: 12px;"></i>
                                            </button>
                                            <button class="action-btn" onclick="markAsUnavailable('SEND-2024-003')" style="color: #ef4444; border-color: #ef4444;">
                                                <i data-feather="user-x" style="width: 12px; height: 12px;"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Distribution Reports Page -->
            <div id="distribution-reports" class="page-content">
                <div class="content-area">
                    <div class="page-header">
                        <div class="breadcrumb">
                            <span class="breadcrumb-item">الرئيسية</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item">إدارة الطرود</span>
                            <span style="color: #cbd5e1;">›</span>
                            <span class="breadcrumb-item active">تقارير التوزيع</span>
                        </div>
                        <h1 class="page-title">تقارير التوزيع</h1>
                        <p class="page-subtitle">إحصائيات وتحليلات شاملة لعمليات التوزيع</p>
                    </div>

                    <!-- Report Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon" style="background: #10b981;">
                                <i data-feather="trending-up"></i>
                            </div>
                            <div class="stat-info">
                                <h3>94.2%</h3>
                                <p>معدل نجاح التوزيع</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +2.1% تحسن
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #3b82f6;">
                                <i data-feather="clock"></i>
                            </div>
                            <div class="stat-info">
                                <h3>2.4</h3>
                                <p>متوسط ساعات التوصيل</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-down" style="width: 14px; height: 14px;"></i>
                                    تحسن بـ 0.3 ساعة
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #f59e0b;">
                                <i data-feather="users"></i>
                            </div>
                            <div class="stat-info">
                                <h3>3,782</h3>
                                <p>مستفيدين وصلهم طرود</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +567 هذا الشهر
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon" style="background: #8b5cf6;">
                                <i data-feather="dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3>$89,450</h3>
                                <p>إجمالي قيمة التوزيعات</p>
                                <div class="stat-change positive">
                                    <i data-feather="trending-up" style="width: 14px; height: 14px;"></i>
                                    +12% زيادة
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts and Analytics -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <div class="form-card">
                            <h3 class="form-card-title">اتجاهات التوزيع</h3>
                            <div style="height: 300px; background: #f8fafc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b;">
                                <i data-feather="trending-up" style="width: 48px; height: 48px; margin-bottom: 16px;"></i>
                                <div>رسم بياني لاتجاهات التوزيع الشهرية</div>
                                <small style="margin-top: 8px;">متوسط 156 طرد يومياً</small>
                            </div>
                        </div>

                        <div class="form-card">
                            <h3 class="form-card-title">توزيع أنواع الطرود</h3>
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px; color: #64748b;">طرود غذائية</span>
                                        <span style="font-size: 14px; font-weight: 600;">65%</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: 65%; background: #f59e0b;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px; color: #64748b;">طرود طبية</span>
                                        <span style="font-size: 14px; font-weight: 600;">20%</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: 20%; background: #ef4444;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px; color: #64748b;">ملابس</span>
                                        <span style="font-size: 14px; font-weight: 600;">10%</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: 10%; background: #8b5cf6;"></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 14px; color: #64748b;">بطانيات</span>
                                        <span style="font-size: 14px; font-weight: 600;">5%</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="height: 100%; width: 5%; background: #06b6d4;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Reports -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-card">
                            <h3 class="form-card-title">أفضل المندوبين</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e293b;">خالد أحمد</div>
                                        <div style="font-size: 12px; color: #64748b;">247 طرد موزع</div>
                                    </div>
                                    <div style="color: #10b981; font-weight: 600;">98.5%</div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e293b;">محمد سعيد</div>
                                        <div style="font-size: 12px; color: #64748b;">234 طرد موزع</div>
                                    </div>
                                    <div style="color: #10b981; font-weight: 600;">96.2%</div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <div>
                                        <div style="font-weight: 600; color: #1e293b;">أحمد علي</div>
                                        <div style="font-size: 12px; color: #64748b;">189 طرد موزع</div>
                                    </div>
                                    <div style="color: #10b981; font-weight: 600;">94.8%</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-card">
                            <h3 class="form-card-title">توزيع حسب المناطق</h3>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="color: #1e293b; font-weight: 500;">شمال غزة</span>
                                    <span style="color: #10b981; font-weight: 600;">387 طرد</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="color: #1e293b; font-weight: 500;">مدينة غزة</span>
                                    <span style="color: #10b981; font-weight: 600;">456 طرد</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="color: #1e293b; font-weight: 500;">الوسط</span>
                                    <span style="color: #10b981; font-weight: 600;">234 طرد</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="color: #1e293b; font-weight: 500;">خان يونس</span>
                                    <span style="color: #10b981; font-weight: 600;">298 طرد</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                    <span style="color: #1e293b; font-weight: 500;">رفح</span>
                                    <span style="color: #10b981; font-weight: 600;">127 طرد</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Template Modal -->
        <div id="templateModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">إنشاء قالب طرد جديد</h3>
                    <button class="modal-close" onclick="closeModal('templateModal')">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <form id="templateForm" onsubmit="handleTemplateSubmit(event)">
                    <div class="form-group">
                        <label class="form-label">اسم القالب *</label>
                        <input type="text" class="form-input" name="templateName" required placeholder="مثال: طرد رمضان كريم 2024">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نوع الطرد *</label>
                        <select class="form-select" name="templateType" required>
                            <option value="">اختر النوع</option>
                            <option value="food">غذائي</option>
                            <option value="medical">طبي</option>
                            <option value="clothing">ملابس</option>
                            <option value="blankets">بطانيات</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">المؤسسة المانحة *</label>
                        <select class="form-select" name="institution" required>
                            <option value="">اختر المؤسسة</option>
                            <option value="unrwa">الأونروا</option>
                            <option value="wfp">برنامج الغذاء العالمي</option>
                            <option value="red-crescent">الهلال الأحمر الفلسطيني</option>
                            <option value="who">منظمة الصحة العالمية</option>
                            <option value="unicef">اليونيسف</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">وصف القالب</label>
                        <textarea class="form-textarea" name="templateDescription" placeholder="وصف تفصيلي للقالب..."></textarea>
                    </div>

                    <!-- Package Contents -->
                    <div class="form-group">
                        <label class="form-label">محتويات الطرد</label>
                        <table class="contents-table">
                            <thead>
                                <tr>
                                    <th>اسم الصنف</th>
                                    <th>الوزن (كيلو)</th>
                                    <th>الكمية</th>
                                    <th>الوحدة</th>
                                    <th>إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="contentsTableBody">
                                <tr>
                                    <td><input type="text" placeholder="مثال: أرز بسمتي" name="itemName[]"></td>
                                    <td><input type="number" placeholder="5" name="itemWeight[]" step="0.1"></td>
                                    <td><input type="number" placeholder="5" name="itemQuantity[]" step="0.1"></td>
                                    <td>
                                        <select name="itemUnit[]">
                                            <option value="كيلو">كيلو</option>
                                            <option value="لتر">لتر</option>
                                            <option value="عدد">عدد</option>
                                            <option value="قطعة">قطعة</option>
                                            <option value="علبة">علبة</option>
                                            <option value="زوج">زوج</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button type="button" class="action-btn delete" onclick="removeContentsRow(this)">
                                            <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="add-item-btn" onclick="addContentsRow()">
                            <i data-feather="plus" style="width: 16px; height: 16px;"></i>
                            إضافة صنف جديد
                        </button>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn" onclick="closeModal('templateModal')">
                            <i data-feather="x"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn" onclick="saveTemplateDraft()">
                            <i data-feather="save"></i>
                            حفظ كمسودة
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i data-feather="check"></i>
                            إنشاء القالب
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Global Variables
        let selectedTemplate = '';
        let selectedInstitution = '';
        let packageContents = [];
        let map;
        let markersLayer;
        let currentMapLayer = 'all';
        let importedBeneficiaries = [];
        
        let beneficiariesData = [
            { id: 'BEN-001', name: 'أحمد محمد الخالدي', idNumber: '900123456', area: 'north', familySize: 'large', hasChildren: true, hasElderly: false, lastReceived: 'month', phone: '0597123456', dateAdded: 'old' },
            { id: 'BEN-002', name: 'فاطمة سالم النجار', idNumber: '900234567', area: 'gaza', familySize: 'medium', hasChildren: true, hasElderly: true, lastReceived: 'week', phone: '0598234567', dateAdded: 'old' },
            { id: 'BEN-003', name: 'محمود عبد الله زقوت', idNumber: '900345678', area: 'middle', familySize: 'small', hasChildren: false, hasElderly: false, lastReceived: 'never', phone: '0599345678', dateAdded: 'old' },
            { id: 'BEN-004', name: 'مريم إبراهيم شعت', idNumber: '900456789', area: 'khan-younis', familySize: 'large', hasChildren: true, hasElderly: false, lastReceived: 'quarter', phone: '0597456789', dateAdded: 'week' },
            { id: 'BEN-005', name: 'يوسف حسن أبو شبكة', idNumber: '900567890', area: 'rafah', familySize: 'medium', hasChildren: false, hasElderly: true, lastReceived: 'month', phone: '0598567890', dateAdded: 'today' },
            { id: 'BEN-006', name: 'نادية علي الفرا', idNumber: '900678901', area: 'north', familySize: 'small', hasChildren: false, hasElderly: false, lastReceived: 'never', phone: '0599678901', dateAdded: 'today' },
            { id: 'BEN-007', name: 'صالح محمد العجلة', idNumber: '900789012', area: 'gaza', familySize: 'large', hasChildren: true, hasElderly: true, lastReceived: 'week', phone: '0597789012', dateAdded: 'month' },
            { id: 'BEN-008', name: 'حنان عمر الشاعر', idNumber: '900890123', area: 'middle', familySize: 'medium', hasChildren: true, hasElderly: false, lastReceived: 'month', phone: '0598890123', dateAdded: 'week' }
        ];

        let templatesData = [
            {
                id: 'TEMP-001',
                name: 'طرد رمضان كريم 2024',
                type: 'food',
                institution: 'الأونروا',
                contents: [
                    { name: 'أرز بسمتي', quantity: 5, size: 1, unit: 'كيلو', weight: 5 },
                    { name: 'زيت زيتون', quantity: 1, size: 1, unit: 'لتر', weight: 1 },
                    { name: 'سكر أبيض', quantity: 2, size: 1, unit: 'كيلو', weight: 2 },
                    { name: 'طحين', quantity: 3, size: 1, unit: 'كيلو', weight: 3 },
                    { name: 'عدس أحمر', quantity: 1, size: 1, unit: 'كيلو', weight: 1 },
                    { name: 'تونة معلبة', quantity: 6, size: 1, unit: 'علبة', weight: 1.2 },
                    { name: 'معجون طماطم', quantity: 3, size: 1, unit: 'علبة', weight: 0.6 },
                    { name: 'حليب مجفف', quantity: 2, size: 1, unit: 'علبة', weight: 0.8 }
                ],
                status: 'active'
            },
            {
                id: 'TEMP-002',
                name: 'طرد الشتاء الدافئ',
                type: 'clothing',
                institution: 'الهلال الأحمر',
                contents: [
                    { name: 'بطانية صوف', quantity: 2, size: 1, unit: 'قطعة', weight: 3 },
                    { name: 'جاكيت شتوي للكبار', quantity: 2, size: 1, unit: 'قطعة', weight: 1.5 },
                    { name: 'جاكيت شتوي للأطفال', quantity: 3, size: 1, unit: 'قطعة', weight: 0.8 },
                    { name: 'جوارب صوفية', quantity: 6, size: 1, unit: 'زوج', weight: 0.3 },
                    { name: 'قبعة صوفية', quantity: 4, size: 1, unit: 'قطعة', weight: 0.2 },
                    { name: 'قفازات', quantity: 4, size: 1, unit: 'زوج', weight: 0.1 }
                ],
                status: 'active'
            }
        ];

        // Mock delivery data for map
        let deliveriesData = [
            { id: 'SEND-2024-001', lat: 31.5012, lng: 34.4662, status: 'delivered', beneficiary: 'أحمد محمد الخالدي', package: 'طرد رمضان كريم 2024', agent: 'خالد أحمد', time: '14:30', date: '15/01/2024', phone: '0597123456', address: 'حي الشجاعية، شارع صلاح الدين' },
            { id: 'SEND-2024-002', lat: 31.4876, lng: 34.4196, status: 'in-progress', beneficiary: 'فاطمة سالم النجار', package: 'طرد الشتاء الدافئ', agent: 'محمد سعيد', time: 'قيد التوزيع', date: '15/01/2024', phone: '0598234567', address: 'حي الزيتون، شارع الوحدة' },
            { id: 'SEND-2024-003', lat: 31.4686, lng: 34.3936, status: 'failed', beneficiary: 'محمود عبد الله زقوت', package: 'طرد الإسعافات الأولية', agent: 'أحمد علي', time: 'فشل التسليم', date: '14/01/2024', phone: '0599345678', address: 'مخيم النصيرات، شارع الشهداء' },
            { id: 'SEND-2024-004', lat: 31.3478, lng: 34.3014, status: 'preparing', beneficiary: 'مريم إبراهيم شعت', package: 'طرد رمضان كريم 2024', agent: 'يوسف حسام', time: 'قيد التحضير', date: '15/01/2024', phone: '0597456789', address: 'خان يونس، حي الأمل' },
            { id: 'SEND-2024-005', lat: 31.2856, lng: 34.2486, status: 'delayed', beneficiary: 'يوسف حسن أبو شبكة', package: 'طرد الشتاء الدافئ', agent: 'سامي محمد', time: 'متأخر 3 ساعات', date: '15/01/2024', phone: '0598567890', address: 'رفح، حي البرازيل' },
            { id: 'SEND-2024-006', lat: 31.5401, lng: 34.5096, status: 'delivered', beneficiary: 'نادية علي الفرا', package: 'طرد طبي', agent: 'خالد أحمد', time: '10:15', date: '15/01/2024', phone: '0599678901', address: 'بيت لاهيا، شارع المدينة' },
            { id: 'SEND-2024-007', lat: 31.5156, lng: 34.4723, status: 'in-progress', beneficiary: 'صالح محمد العجلة', package: 'طرد رمضان كريم 2024', agent: 'محمد سعيد', time: 'في الطريق', date: '15/01/2024', phone: '0597789012', address: 'جباليا، شارع فلسطين' }
        ];

        // Institution Selection Functions
        function selectInstitutionQuick(institutionId, element) {
            // Remove selected class from all quick buttons
            document.querySelectorAll('.popular-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            element.classList.add('selected');
            
            // Remove selected class from list items
            document.querySelectorAll('.institution-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select corresponding item in list
            const listItem = document.querySelector(`[data-institution="${institutionId}"]`);
            if (listItem) {
                listItem.classList.add('selected');
            }
            
            // Set selected institution
            selectedInstitution = institutionId;
            document.getElementById('selectedInstitution').value = institutionId;
            
            // Show templates section
            showTemplatesForInstitution(institutionId);
            
            console.log('Institution selected (quick):', institutionId);
        }

        function selectInstitutionFromList(institutionId, element) {
            // Remove selected class from all list items
            document.querySelectorAll('.institution-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to clicked item
            element.classList.add('selected');
            
            // Remove selected class from quick buttons
            document.querySelectorAll('.popular-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select corresponding quick button if exists
            const quickBtn = document.querySelector(`.popular-btn[onclick*="${institutionId}"]`);
            if (quickBtn) {
                quickBtn.classList.add('selected');
            }
            
            // Set selected institution
            selectedInstitution = institutionId;
            document.getElementById('selectedInstitution').value = institutionId;
            
            // Show templates section
            showTemplatesForInstitution(institutionId);
            
            console.log('Institution selected (list):', institutionId);
        }

        function showTemplatesForInstitution(institutionId) {
            const templatesSection = document.getElementById('templatesSection');
            const institutionTemplates = document.getElementById('institutionTemplates');
            
            // Get templates for this institution
            const institutionNames = {
                'unrwa': 'الأونروا',
                'wfp': 'برنامج الغذاء العالمي', 
                'red-crescent': 'الهلال الأحمر الفلسطيني',
                'who': 'منظمة الصحة العالمية',
                'unicef': 'اليونيسف',
                'unesco': 'منظمة اليونسكو',
                'qatar-charity': 'مؤسسة قطر الخيرية'
            };
            
            const institutionName = institutionNames[institutionId];
            
            // Filter templates by institution
            const availableTemplates = templatesData.filter(template => {
                if (institutionId === 'unrwa') return template.institution === 'الأونروا';
                if (institutionId === 'wfp') return template.institution === 'برنامج الغذاء العالمي';
                if (institutionId === 'red-crescent') return template.institution === 'الهلال الأحمر';
                if (institutionId === 'who') return template.institution === 'منظمة الصحة العالمية';
                if (institutionId === 'unicef') return template.institution === 'اليونيسف';
                return false;
            });
            
            // Add some additional templates for institutions
            if (institutionId === 'unrwa') {
                availableTemplates.push(
                    {
                        id: 'TEMP-006',
                        name: 'طرد الأونروا الغذائي الأساسي',
                        type: 'food',
                        institution: 'الأونروا',
                        contents: [
                            { name: 'أرز', quantity: 3, unit: 'كيلو', weight: 3 },
                            { name: 'زيت طبخ', quantity: 1, unit: 'لتر', weight: 1 },
                            { name: 'عدس', quantity: 2, unit: 'كيلو', weight: 2 }
                        ],
                        status: 'active'
                    },
                    {
                        id: 'TEMP-007',
                        name: 'طرد الأونروا للعائلات الكبيرة',
                        type: 'food',
                        institution: 'الأونروا',
                        contents: [
                            { name: 'أرز بسمتي', quantity: 10, unit: 'كيلو', weight: 10 },
                            { name: 'زيت زيتون', quantity: 2, unit: 'لتر', weight: 2 },
                            { name: 'سكر', quantity: 3, unit: 'كيلو', weight: 3 }
                        ],
                        status: 'active'
                    }
                );
            }
            
            if (institutionId === 'wfp') {
                availableTemplates.push({
                    id: 'TEMP-008',
                    name: 'طرد غذائي أساسي - برنامج الغذاء العالمي',
                    type: 'food',
                    institution: 'برنامج الغذاء العالمي',
                    contents: [
                        { name: 'أرز', quantity: 5, unit: 'كيلو', weight: 5 },
                        { name: 'فول', quantity: 2, unit: 'كيلو', weight: 2 }
                    ],
                    status: 'active'
                });
            }
            
            if (institutionId === 'unicef') {
                availableTemplates.push({
                    id: 'TEMP-009',
                    name: 'طرد غذائي للأطفال - اليونيسف',
                    type: 'food',
                    institution: 'اليونيسف',
                    contents: [
                        { name: 'حليب أطفال', quantity: 6, unit: 'علبة', weight: 3 },
                        { name: 'بسكويت أطفال', quantity: 10, unit: 'علبة', weight: 2 }
                    ],
                    status: 'active'
                });
            }
            
            // Generate templates HTML
            let templatesHtml = `<div class="package-type-selector">`;
            
            availableTemplates.forEach(template => {
                const typeIcon = template.type === 'food' ? 'package' : 
                               template.type === 'medical' ? 'heart' : 
                               template.type === 'clothing' ? 'layers' : 'gift';
                               
                const totalWeight = template.contents.reduce((sum, item) => sum + item.weight, 0);
                
                templatesHtml += `
                    <div class="package-type-card" onclick="selectTemplate('${template.id}', this)">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i data-feather="${typeIcon}" style="width: 20px; height: 20px; color: #3b82f6;"></i>
                            <div class="package-type-title">${template.name}</div>
                        </div>
                        <div class="package-type-desc">
                            ${template.contents.length} أصناف • ${totalWeight} كيلو<br>
                            <small style="color: #10b981;">متاح للإرسال</small>
                        </div>
                    </div>
                `;
            });
            
            templatesHtml += `</div>`;
            
            institutionTemplates.innerHTML = templatesHtml;
            templatesSection.classList.add('active');
            
            // Reinitialize feather icons
            feather.replace();
        }

        function showRealExample() {
            // Add 5 real example beneficiaries
            const exampleBeneficiaries = [
                {
                    id: 'BEN-EX-001',
                    name: 'سميرة أحمد أبو عامر',
                    idNumber: '901234567',
                    phone: '0591234567',
                    area: 'gaza',
                    familySize: 'large',
                    hasChildren: true,
                    hasElderly: true,
                    lastReceived: 'never',
                    dateAdded: 'today'
                },
                {
                    id: 'BEN-EX-002',
                    name: 'محمد عبد الرحمن قاسم',
                    idNumber: '902345678',
                    phone: '0592345678',
                    area: 'north',
                    familySize: 'medium',
                    hasChildren: true,
                    hasElderly: false,
                    lastReceived: 'never',
                    dateAdded: 'today'
                },
                {
                    id: 'BEN-EX-003',
                    name: 'نورا سليم الحلو',
                    idNumber: '903456789',
                    phone: '0593456789',
                    area: 'khan-younis',
                    familySize: 'small',
                    hasChildren: false,
                    hasElderly: true,
                    lastReceived: 'never',
                    dateAdded: 'today'
                },
                {
                    id: 'BEN-EX-004',
                    name: 'خالد يوسف البرغوثي',
                    idNumber: '904567890',
                    phone: '0594567890',
                    area: 'middle',
                    familySize: 'large',
                    hasChildren: true,
                    hasElderly: false,
                    lastReceived: 'never',
                    dateAdded: 'today'
                },
                {
                    id: 'BEN-EX-005',
                    name: 'ريم محمود الشامي',
                    idNumber: '905678901',
                    phone: '0595678901',
                    area: 'rafah',
                    familySize: 'medium',
                    hasChildren: true,
                    hasElderly: true,
                    lastReceived: 'never',
                    dateAdded: 'today'
                }
            ];
            
            // Add to beneficiaries data
            beneficiariesData = [...beneficiariesData, ...exampleBeneficiaries];
            importedBeneficiaries = exampleBeneficiaries;
            
            // Show import results
            document.getElementById('importResults').style.display = 'block';
            document.getElementById('importSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div><strong>تم الإضافة:</strong> 5</div>
                    <div><strong>أخطاء:</strong> 0</div>
                    <div><strong>الإجمالي:</strong> 5</div>
                </div>
                <div style="font-size: 12px; color: #64748b;">
                    تم إضافة 5 مستفيدين تجريبيين للنظام. يمكنك الآن اختيارهم من فلتر "المستفيدين الجدد المستوردين".
                </div>
            `;
            
            // Update beneficiaries preview
            updateBeneficiariesPreview();
            
            // Show success message
            alert('تم إضافة 5 مستفيدين تجريبيين بنجاح!\n\nيمكنك الآن رؤية كيفية عمل النظام مع البيانات الحقيقية.');
        }

        function updateIndividualTemplateOptions() {
            const templateSelect = document.getElementById('individualTemplate');
            if (!templateSelect) return;
            
            // Clear existing options except the first one
            templateSelect.innerHTML = '<option value="">اختر قالب الطرد</option>';
            
            // Add all available templates
            templatesData.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} - ${template.institution} (${getTypeInArabic(template.type)})`;
                templateSelect.appendChild(option);
            });
            
            // Add additional templates
            const additionalTemplates = [
                { id: 'TEMP-006', name: 'طرد الأونروا الغذائي الأساسي', institution: 'الأونروا', type: 'غذائي' },
                { id: 'TEMP-007', name: 'طرد الأونروا للعائلات الكبيرة', institution: 'الأونروا', type: 'غذائي' },
                { id: 'TEMP-004', name: 'طرد غذائي للأطفال', institution: 'اليونيسف', type: 'غذائي' },
                { id: 'TEMP-005', name: 'طرد غذائي أساسي', institution: 'برنامج الغذاء العالمي', type: 'غذائي' }
            ];
            
            additionalTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} - ${template.institution} (${template.type})`;
                templateSelect.appendChild(option);
            });
        }

        function getTypeInArabic(type) {
            const types = {
                'food': 'غذائي',
                'medical': 'طبي',
                'clothing': 'ملابس',
                'blankets': 'بطانيات'
            };
            return types[type] || type;
        }

        function handleIndividualTemplateChange() {
            const templateSelect = document.getElementById('individualTemplate');
            const templateDetails = document.getElementById('templateDetails');
            const templateInfo = document.getElementById('templateInfo');
            
            if (templateSelect.value) {
                const template = templatesData.find(t => t.id === templateSelect.value);
                if (template) {
                    const totalWeight = template.contents.reduce((sum, item) => sum + item.weight, 0);
                    templateInfo.innerHTML = `
                        <strong>النوع:</strong> ${getTypeInArabic(template.type)}<br>
                        <strong>المؤسسة:</strong> ${template.institution}<br>
                        <strong>عدد الأصناف:</strong> ${template.contents.length}<br>
                        <strong>الوزن الإجمالي:</strong> ${totalWeight} كيلو
                    `;
                    templateDetails.style.display = 'block';
                } else {
                    // Handle additional templates
                    templateInfo.innerHTML = `
                        <strong>القالب:</strong> ${templateSelect.options[templateSelect.selectedIndex].text}<br>
                        <strong>الحالة:</strong> متاح للإرسال
                    `;
                    templateDetails.style.display = 'block';
                }
            } else {
                templateDetails.style.display = 'none';
            }
        }

        function searchBeneficiaryLive() {
            const searchTerm = document.getElementById('beneficiarySearch').value.toLowerCase();
            const results = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                results.style.display = 'none';
                return;
            }
            
            const matches = beneficiariesData.filter(beneficiary => 
                beneficiary.name.toLowerCase().includes(searchTerm) || 
                beneficiary.idNumber.includes(searchTerm)
            ).slice(0, 5);
            
            if (matches.length > 0) {
                let resultsHtml = '';
                matches.forEach(beneficiary => {
                    resultsHtml += `
                        <div class="search-result-item" onmousedown="selectBeneficiaryFromSearch('${beneficiary.id}')">
                            <div class="result-name">${beneficiary.name}</div>
                            <div class="result-details">${beneficiary.idNumber} - ${getAreaName(beneficiary.area)} - ${beneficiary.phone}</div>
                        </div>
                    `;
                });
                results.innerHTML = resultsHtml;
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }

        function selectBeneficiaryFromSearch(beneficiaryId) {
            const beneficiary = beneficiariesData.find(b => b.id === beneficiaryId);
            if (beneficiary) {
                document.getElementById('beneficiarySearch').value = beneficiary.name;
                document.getElementById('beneficiarySelect').value = beneficiaryId;
                document.getElementById('searchResults').style.display = 'none';
                showBeneficiaryDetails(beneficiary);
            }
        }

        function handleBeneficiarySelectChange() {
            const beneficiarySelect = document.getElementById('beneficiarySelect');
            const beneficiarySearch = document.getElementById('beneficiarySearch');
            
            if (beneficiarySelect.value) {
                const beneficiary = beneficiariesData.find(b => b.id === beneficiarySelect.value);
                if (beneficiary) {
                    beneficiarySearch.value = beneficiary.name;
                    showBeneficiaryDetails(beneficiary);
                }
            }
        }

        function showBeneficiaryDetails(beneficiary) {
            const detailsDiv = document.getElementById('beneficiaryDetails');
            const infoDiv = document.getElementById('beneficiaryInfo');
            
            infoDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div><strong>الاسم:</strong> ${beneficiary.name}</div>
                    <div><strong>رقم الهوية:</strong> ${beneficiary.idNumber}</div>
                    <div><strong>رقم الهاتف:</strong> ${beneficiary.phone}</div>
                    <div><strong>المنطقة:</strong> ${getAreaName(beneficiary.area)}</div>
                    <div><strong>حجم الأسرة:</strong> ${getFamilySizeName(beneficiary.familySize)}</div>
                    <div><strong>آخر استلام:</strong> ${getLastReceivedText(beneficiary.lastReceived)}</div>
                </div>
            `;
            detailsDiv.style.display = 'block';
        }

        function getLastReceivedText(lastReceived) {
            const texts = {
                'never': 'لم يستلم من قبل',
                'week': 'خلال أسبوع',
                'month': 'خلال شهر',
                'quarter': 'خلال 3 أشهر'
            };
            return texts[lastReceived] || lastReceived;
        }

        function showSearchResults() {
            const searchTerm = document.getElementById('beneficiarySearch').value;
            if (searchTerm.length >= 2) {
                searchBeneficiaryLive();
            }
        }

        function hideSearchResults() {
            setTimeout(() => {
                document.getElementById('searchResults').style.display = 'none';
            }, 200);
        }

        function getCurrentFilters() {
            return {
                benefitStatus: document.getElementById('benefitStatus').value,
                familySize: document.getElementById('familySize').value,
                hasChildren: document.getElementById('hasChildren').value,
                hasElderly: document.getElementById('hasElderly').value,
                area: document.getElementById('area').value,
                lastReceived: document.getElementById('lastReceived').value,
                dateAdded: document.getElementById('dateAdded').value
            };
        }

        function getFilteredBeneficiaries() {
            const filters = getCurrentFilters();
            
            return beneficiariesData.filter(beneficiary => {
                let matches = true;

                if (filters.benefitStatus) {
                    if (filters.benefitStatus === 'never' && beneficiary.lastReceived !== 'never') matches = false;
                    if (filters.benefitStatus === 'recent' && beneficiary.lastReceived === 'never') matches = false;
                    if (filters.benefitStatus === 'old' && (beneficiary.lastReceived === 'never' || beneficiary.lastReceived === 'week')) matches = false;
                    if (filters.benefitStatus === 'new-imported' && beneficiary.dateAdded !== 'today') matches = false;
                }

                if (filters.familySize && beneficiary.familySize !== filters.familySize) matches = false;
                if (filters.hasChildren) {
                    if (filters.hasChildren === 'yes' && !beneficiary.hasChildren) matches = false;
                    if (filters.hasChildren === 'no' && beneficiary.hasChildren) matches = false;
                }
                if (filters.hasElderly) {
                    if (filters.hasElderly === 'yes' && !beneficiary.hasElderly) matches = false;
                    if (filters.hasElderly === 'no' && beneficiary.hasElderly) matches = false;
                }
                if (filters.area && beneficiary.area !== filters.area) matches = false;
                if (filters.lastReceived && beneficiary.lastReceived !== filters.lastReceived) matches = false;
                if (filters.dateAdded) {
                    if (filters.dateAdded === 'today' && beneficiary.dateAdded !== 'today') matches = false;
                    if (filters.dateAdded === 'week' && !['today', 'week'].includes(beneficiary.dateAdded)) matches = false;
                    if (filters.dateAdded === 'month' && !['today', 'week', 'month'].includes(beneficiary.dateAdded)) matches = false;
                }

                return matches;
            });
        }

        function getFilterText(filterType, value) {
            const filterTexts = {
                benefitStatus: {
                    'never': 'لم يستفيدوا مطلقاً',
                    'recent': 'استفادوا مؤخراً', 
                    'old': 'لم يستفيدوا منذ فترة',
                    'new-imported': 'المستفيدين الجدد المستوردين'
                },
                familySize: {
                    'small': 'أقل من 5 أشخاص',
                    'medium': '5-10 أشخاص',
                    'large': 'أكبر من 10 أشخاص'
                }
            };
            return filterTexts[filterType] && filterTexts[filterType][value] || value;
        }

        function confirmSendFromPreview() {
            const institutionNames = {
                'unrwa': 'الأونروا',
                'wfp': 'برنامج الغذاء العالمي',
                'red-crescent': 'الهلال الأحمر الفلسطيني',
                'who': 'منظمة الصحة العالمية',
                'unicef': 'اليونيسف'
            };
            
            const template = templatesData.find(t => t.id === selectedTemplate);
            const institutionName = institutionNames[selectedInstitution];
            const count = document.getElementById('previewBeneficiariesCount').textContent;
            
            const sendId = 'SEND-2024-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            
            alert(`تم تأكيد الإرسال بنجاح!\n\nرقم الإرسالية: ${sendId}\nالمؤسسة: ${institutionName}\nقالب الطرد: ${template.name}\nعدد المستفيدين: ${count}\n\nسيتم البدء في التحضير والتوزيع`);
            
            // Close modal and reset form
            closeModal('previewSendModal');
            
            // Reset form
            selectedTemplate = '';
            selectedInstitution = '';
            document.querySelectorAll('.institution-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelectorAll('.popular-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.package-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('templatesSection').classList.remove('active');
            document.querySelectorAll('select').forEach(select => {
                select.value = '';
            });
            updateBeneficiariesPreview();
        }

        // Initialize Map
        function initializeMap() {
            if (typeof L !== 'undefined' && document.getElementById('trackingMap')) {
                // Gaza Strip coordinates
                map = L.map('trackingMap').setView([31.4686, 34.3956], 10);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                // Create markers layer
                markersLayer = L.layerGroup().addTo(map);
                
                // Add delivery markers
                updateMapMarkers();
            }
        }

        // Update map markers based on current filter
        function updateMapMarkers() {
            if (!markersLayer) return;
            
            markersLayer.clearLayers();
            
            deliveriesData.forEach(delivery => {
                if (currentMapLayer === 'all' || delivery.status === currentMapLayer) {
                    const color = getStatusColor(delivery.status);
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    const marker = L.marker([delivery.lat, delivery.lng], { icon }).addTo(markersLayer);
                    
                    const popupContent = `
                        <div style="font-family: 'Tajawal', sans-serif; text-align: right; direction: rtl; min-width: 250px;">
                            <h4 style="margin: 0 0 8px 0; color: #1e293b;">${delivery.id}</h4>
                            <div style="font-size: 13px; line-height: 1.5;">
                                <strong>المستفيد:</strong> ${delivery.beneficiary}<br>
                                <strong>نوع الطرد:</strong> ${delivery.package}<br>
                                <strong>المندوب:</strong> ${delivery.agent}<br>
                                <strong>الحالة:</strong> <span style="color: ${color};">${getStatusText(delivery.status)}</span><br>
                                <strong>الوقت:</strong> ${delivery.time}<br>
                                <strong>الهاتف:</strong> ${delivery.phone}<br>
                                <strong>العنوان:</strong> ${delivery.address}
                            </div>
                            <div style="margin-top: 10px; text-align: center;">
                                <button onclick="viewDeliveryFromMap('${delivery.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    عرض التفاصيل
                                </button>
                            </div>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'delivered': '#10b981',
                'in-progress': '#3b82f6',
                'preparing': '#f59e0b',
                'failed': '#ef4444',
                'delayed': '#8b5cf6'
            };
            return colors[status] || '#6b7280';
        }

        // Get status text in Arabic
        function getStatusText(status) {
            const texts = {
                'delivered': 'تم التوصيل',
                'in-progress': 'قيد التوزيع',
                'preparing': 'قيد التحضير',
                'failed': 'فشل التسليم',
                'delayed': 'متأخر'
            };
            return texts[status] || status;
        }

        // Toggle map layer
        function toggleMapLayer(layer) {
            currentMapLayer = layer;
            
            // Update button states
            document.querySelectorAll('.map-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('layer' + layer.charAt(0).toUpperCase() + layer.slice(1).replace('-', '')).classList.add('active');
            
            updateMapMarkers();
        }

        // View delivery from map
        function viewDeliveryFromMap(deliveryId) {
            viewDelivery(deliveryId);
        }

        // Notification Functions
        function dismissNotification(button) {
            button.closest('.notifications-bar').style.display = 'none';
        }

        function viewDelayedPackages() {
            showPage('package-tracking');
            alert('عرض الطرود المتأخرة...');
        }

        function contactSupplier(supplier) {
            alert(`التواصل مع مورد: ${supplier}`);
        }

        function viewNewBeneficiaries() {
            showPage('bulk-send');
            alert('عرض المستفيدين الجدد...');
        }

        // Import Functions
        function downloadTemplate() {
            const csvContent = "اسم المستفيد,رقم الهوية,رقم الهاتف,المنطقة,عدد الأفراد,لديه أطفال,كبار سن,ملاحظات\n" +
                              "أحمد محمد الخالدي,900123456,0597123456,شمال غزة,6,نعم,لا,حالة عاجلة\n" +
                              "فاطمة سالم النجار,900234567,0598234567,مدينة غزة,5,نعم,نعم,";
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'قالب_المستفيدين.csv';
            link.click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    const headers = lines[0].split(',');
                    
                    let importedCount = 0;
                    let errorCount = 0;
                    const newBeneficiaries = [];

                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            if (values.length >= 5) {
                                const newBeneficiary = {
                                    id: 'BEN-IMP-' + String(importedCount + 1).padStart(3, '0'),
                                    name: values[0]?.trim() || '',
                                    idNumber: values[1]?.trim() || '',
                                    phone: values[2]?.trim() || '',
                                    area: mapAreaName(values[3]?.trim() || ''),
                                    familySize: parseInt(values[4]) > 7 ? 'large' : (parseInt(values[4]) > 4 ? 'medium' : 'small'),
                                    hasChildren: values[5]?.trim().toLowerCase() === 'نعم' || values[5]?.trim().toLowerCase() === 'yes',
                                    hasElderly: values[6]?.trim().toLowerCase() === 'نعم' || values[6]?.trim().toLowerCase() === 'yes',
                                    lastReceived: 'never',
                                    dateAdded: 'today'
                                };
                                
                                newBeneficiaries.push(newBeneficiary);
                                importedCount++;
                            } else {
                                errorCount++;
                            }
                        }
                    }

                    // Add to beneficiaries data
                    beneficiariesData = [...beneficiariesData, ...newBeneficiaries];
                    importedBeneficiaries = newBeneficiaries;

                    // Show results
                    document.getElementById('importResults').style.display = 'block';
                    document.getElementById('importSummary').innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                            <div><strong>تم الاستيراد:</strong> ${importedCount}</div>
                            <div><strong>أخطاء:</strong> ${errorCount}</div>
                            <div><strong>الإجمالي:</strong> ${importedCount + errorCount}</div>
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            تم إضافة المستفيدين الجدد بنجاح. يمكنك الآن اختيارهم من فلتر "المستفيدين الجدد المستوردين".
                        </div>
                    `;

                    // Update beneficiaries preview
                    updateBeneficiariesPreview();

                    // Show success notification
                    showNotification('success', `تم استيراد ${importedCount} مستفيد جديد بنجاح`);

                } catch (error) {
                    alert('خطأ في قراءة الملف. يرجى التأكد من تنسيق الملف.');
                }
            };
            reader.readAsText(file);
        }

        function mapAreaName(areaName) {
            const areaMap = {
                'شمال غزة': 'north',
                'مدينة غزة': 'gaza',
                'الوسط': 'middle',
                'خان يونس': 'khan-younis',
                'رفح': 'rafah'
            };
            return areaMap[areaName] || 'gaza';
        }

        function showNotification(type, message) {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            notification.className = `notifications-bar ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i data-feather="check-circle" class="notification-icon"></i>
                    <div class="notification-text">${message}</div>
                </div>
                <div class="notification-actions">
                    <button class="notification-btn secondary" onclick="dismissNotification(this)">إغلاق</button>
                </div>
            `;
            container.appendChild(notification);
            feather.replace();
        }

        // Reschedule Functions
        function rescheduleDelivery(deliveryId) {
            // Find delivery data
            const delivery = deliveriesData.find(d => d.id === deliveryId);
            if (delivery) {
                // Set default reason based on status
                let reason = 'لم يتم العثور على المستفيد في العنوان المحدد';
                if (delivery.status === 'failed') {
                    reason = 'فشل في التسليم - يحتاج إعادة محاولة';
                }
                
                document.getElementById('rescheduleReason').textContent = reason;
                
                // Set current date + 1 day as default
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('rescheduleDate').value = tomorrow.toISOString().split('T')[0];
            }
            
            document.getElementById('rescheduleModal').classList.add('active');
            feather.replace();
        }

        function selectRescheduleReason(element, reason) {
            document.querySelectorAll('.reschedule-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function confirmReschedule() {
            const date = document.getElementById('rescheduleDate').value;
            const time = document.getElementById('rescheduleTime').value;
            const agent = document.getElementById('alternativeAgent').value;
            
            if (!date || !time) {
                alert('يرجى اختيار تاريخ ووقت إعادة التوصيل');
                return;
            }

            let message = `تم تأكيد إعادة الجدولة:\n\nالتاريخ: ${date}\nالوقت: ${time}`;
            if (agent) {
                const agentNames = {
                    'agent-2': 'محمد سعيد',
                    'agent-3': 'أحمد علي', 
                    'agent-4': 'يوسف حسام'
                };
                message += `\nمندوب بديل: ${agentNames[agent]}`;
            }
            
            alert(message);
            closeModal('rescheduleModal');
            
            // Reset form
            document.getElementById('rescheduleDate').value = '';
            document.getElementById('rescheduleTime').value = '';
            document.getElementById('alternativeAgent').value = '';
            document.querySelectorAll('.reschedule-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function markAsUnavailable(deliveryId) {
            const delivery = deliveriesData.find(d => d.id === deliveryId);
            const beneficiaryName = delivery ? delivery.beneficiary : 'المستفيد';
            
            if (confirm(`هل أنت متأكد من تسجيل "${beneficiaryName}" كغير متاح؟\n\nسيتم:\n- وضع علامة "غير متاح" على الحساب\n- إيقاف المحاولات الأخرى\n- إرسال تقرير للإدارة`)) {
                alert(`تم تسجيل "${beneficiaryName}" كغير متاح\nتم إرسال تقرير للإدارة للمراجعة`);
                
                // هنا يمكن إضافة منطق لتحديث حالة المستفيد في قاعدة البيانات
            }
        }

        // Mobile menu toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Menu functionality
        function toggleSubmenu(element) {
            const menuItem = element.parentElement;
            const isExpanded = menuItem.classList.contains('expanded');
            
            // Close all other submenus
            document.querySelectorAll('.menu-item.expanded').forEach(item => {
                if (item !== menuItem) {
                    item.classList.remove('expanded');
                }
            });
            
            // Toggle current submenu
            menuItem.classList.toggle('expanded');
            
            // Re-initialize icons
            feather.replace();
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Initialize map if showing tracking page
                if (pageId === 'package-tracking') {
                    setTimeout(() => {
                        if (!map) {
                            initializeMap();
                        } else {
                            map.invalidateSize();
                        }
                    }, 100);
                }
            }
            
            // Update active menu item
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.querySelectorAll('.submenu-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to current menu item
            if (event && event.target) {
                const clickedElement = event.target.closest('.menu-link') || event.target.closest('.submenu-link');
                if (clickedElement) {
                    clickedElement.classList.add('active');
                }
            }
            
            // Re-initialize icons
            feather.replace();
        }

        // Template Management Functions
        function openTemplateModal() {
            const modal = document.getElementById('templateModal');
            modal.classList.add('active');
            feather.replace();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
        }

        function addContentsRow() {
            const tbody = document.getElementById('contentsTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="اسم الصنف" name="itemName[]"></td>
                <td><input type="number" placeholder="الكمية" name="itemQuantity[]" step="0.1"></td>
                <td><input type="number" placeholder="الحجم" name="itemSize[]" step="0.1"></td>
                <td>
                    <select name="itemUnit[]">
                        <option value="كيلو">كيلو</option>
                        <option value="لتر">لتر</option>
                        <option value="عدد">عدد</option>
                        <option value="قطعة">قطعة</option>
                        <option value="علبة">علبة</option>
                        <option value="زوج">زوج</option>
                    </select>
                </td>
                <td><input type="number" placeholder="الوزن" name="itemWeight[]" step="0.1"></td>
                <td>
                    <button type="button" class="action-btn delete" onclick="removeContentsRow(this)">
                        <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
            feather.replace();
        }

        function removeContentsRow(button) {
            button.closest('tr').remove();
        }

        function handleTemplateSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const templateData = {
                id: 'TEMP-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
                name: formData.get('templateName'),
                type: formData.get('templateType'),
                institution: formData.get('institution'),
                description: formData.get('templateDescription'),
                contents: [],
                status: 'active',
                created: new Date().toISOString().split('T')[0]
            };

            // Collect contents data
            const itemNames = formData.getAll('itemName[]');
            const itemQuantities = formData.getAll('itemQuantity[]');
            const itemSizes = formData.getAll('itemSize[]');
            const itemUnits = formData.getAll('itemUnit[]');
            const itemWeights = formData.getAll('itemWeight[]');

            for (let i = 0; i < itemNames.length; i++) {
                if (itemNames[i]) {
                    templateData.contents.push({
                        name: itemNames[i],
                        quantity: parseFloat(itemQuantities[i]) || 0,
                        size: parseFloat(itemSizes[i]) || 0,
                        unit: itemUnits[i],
                        weight: parseFloat(itemWeights[i]) || 0
                    });
                }
            }

            alert('تم إنشاء قالب الطرد بنجاح!\nمعرف القالب: ' + templateData.id);
            
            // Reset form and close modal
            event.target.reset();
            closeModal('templateModal');
            
            // Refresh templates table if needed
            // refreshTemplatesTable();
        }

        function saveTemplateDraft() {
            alert('تم حفظ القالب كمسودة');
        }

        function viewTemplate(templateId) {
            const template = templatesData.find(t => t.id === templateId);
            if (template) {
                // Update modal content
                document.getElementById('viewTemplateId').textContent = template.id;
                document.getElementById('viewTemplateName').textContent = template.name;
                document.getElementById('viewTemplateType').textContent = getTypeInArabic(template.type);
                document.getElementById('viewTemplateInstitution').textContent = template.institution;
                document.getElementById('viewTemplateStatus').textContent = template.status === 'active' ? 'نشط' : 'غير نشط';
                
                const totalWeight = template.contents.reduce((sum, item) => sum + item.weight, 0);
                document.getElementById('viewTemplateTotalWeight').textContent = totalWeight + ' كيلو';
                document.getElementById('viewTemplateItemsCount').textContent = template.contents.length + ' صنف';
                
                // Show contents
                let contentsHtml = '';
                template.contents.forEach(item => {
                    contentsHtml += `
                        <div class="content-item">
                            <div>
                                <div class="content-name">${item.name}</div>
                                <div class="content-details">${item.quantity} ${item.unit} × ${item.size || 1} = ${item.weight} كيلو</div>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('viewTemplateContents').innerHTML = contentsHtml;
                
                // Store current template for actions
                window.currentViewTemplate = templateId;
                
                // Show modal
                document.getElementById('templateViewModal').classList.add('active');
                feather.replace();
            }
        }

        function editTemplate(templateId) {
            const template = templatesData.find(t => t.id === templateId);
            if (template) {
                // Set editing mode
                window.editingTemplateId = templateId;
                
                // Update modal title
                document.querySelector('#templateModal .modal-title').textContent = 'تعديل قالب الطرد';
                document.querySelector('#templateForm button[type="submit"]').innerHTML = '<i data-feather="check"></i> حفظ التعديلات';
                
                // Fill form with template data
                document.querySelector('input[name="templateName"]').value = template.name;
                document.querySelector('select[name="templateType"]').value = template.type;
                document.querySelector('select[name="institution"]').value = getInstitutionId(template.institution);
                document.querySelector('textarea[name="templateDescription"]').value = template.description || '';
                
                // Fill contents table
                const tbody = document.getElementById('contentsTableBody');
                tbody.innerHTML = '';
                
                template.contents.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="text" name="itemName[]" value="${item.name}"></td>
                        <td><input type="number" name="itemQuantity[]" step="0.1" value="${item.quantity}"></td>
                        <td><input type="number" name="itemSize[]" step="0.1" value="${item.size || 1}"></td>
                        <td>
                            <select name="itemUnit[]">
                                <option value="كيلو" ${item.unit === 'كيلو' ? 'selected' : ''}>كيلو</option>
                                <option value="لتر" ${item.unit === 'لتر' ? 'selected' : ''}>لتر</option>
                                <option value="عدد" ${item.unit === 'عدد' ? 'selected' : ''}>عدد</option>
                                <option value="قطعة" ${item.unit === 'قطعة' ? 'selected' : ''}>قطعة</option>
                                <option value="علبة" ${item.unit === 'علبة' ? 'selected' : ''}>علبة</option>
                                <option value="زوج" ${item.unit === 'زوج' ? 'selected' : ''}>زوج</option>
                            </select>
                        </td>
                        <td><input type="number" name="itemWeight[]" step="0.1" value="${item.weight}"></td>
                        <td>
                            <button type="button" class="action-btn delete" onclick="removeContentsRow(this)">
                                <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Show modal
                openTemplateModal();
            }
        }

        function getInstitutionId(institutionName) {
            const institutions = {
                'الأونروا': 'unrwa',
                'برنامج الغذاء العالمي': 'wfp',
                'الهلال الأحمر': 'red-crescent',
                'منظمة الصحة العالمية': 'who',
                'اليونيسف': 'unicef'
            };
            return institutions[institutionName] || '';
        }

        function duplicateTemplate(templateId) {
            const template = templatesData.find(t => t.id === templateId);
            if (template) {
                const newTemplate = {
                    ...template,
                    id: 'TEMP-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
                    name: template.name + ' (نسخة)',
                    status: 'draft'
                };
                templatesData.push(newTemplate);
                alert(`تم نسخ القالب بنجاح!\nمعرف القالب الجديد: ${newTemplate.id}`);
            }
        }

        function deleteTemplate(templateId) {
            if (confirm('هل أنت متأكد من حذف هذا القالب؟\n\nلن تتمكن من التراجع عن هذا الإجراء.')) {
                const index = templatesData.findIndex(t => t.id === templateId);
                if (index > -1) {
                    templatesData.splice(index, 1);
                    alert('تم حذف القالب بنجاح');
                    // Here you would typically refresh the table
                }
            }
        }

        function editTemplateFromView() {
            if (window.currentViewTemplate) {
                closeModal('templateViewModal');
                editTemplate(window.currentViewTemplate);
            }
        }

        function duplicateTemplateFromView() {
            if (window.currentViewTemplate) {
                duplicateTemplate(window.currentViewTemplate);
                closeModal('templateViewModal');
            }
        }

        function useTemplateFromView() {
            if (window.currentViewTemplate) {
                selectedTemplate = window.currentViewTemplate;
                closeModal('templateViewModal');
                showPage('bulk-send');
                
                // Auto-select template if we're on bulk send page
                setTimeout(() => {
                    const templateCard = document.querySelector(`[onclick*="${selectedTemplate}"]`);
                    if (templateCard) {
                        templateCard.click();
                    }
                }, 500);
            }
        }

        function printDeliveryReport() {
            const deliveryId = document.getElementById('deliveryId').textContent;
            alert(`طباعة تقرير الإرسالية: ${deliveryId}\n\nسيتم إنشاء ملف PDF وإرساله للطابعة...`);
        }

        // Sort table function
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.getElementById('trackingTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Toggle sort direction
            const currentDirection = sortDirection[columnIndex] || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            sortDirection[columnIndex] = newDirection;
            
            // Update sort arrows
            document.querySelectorAll('.sort-arrow').forEach(arrow => {
                arrow.className = 'sort-arrow none';
                arrow.innerHTML = '';
            });
            
            const currentArrow = document.getElementById(`sort-${columnIndex}`);
            currentArrow.className = `sort-arrow ${newDirection}`;
            
            // Sort rows
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                // Handle different data types
                let aValue = aText;
                let bValue = bText;
                
                // Check if it's a date
                if (aText.match(/\d{4}-\d{2}-\d{2}/)) {
                    aValue = new Date(aText);
                    bValue = new Date(bText);
                } else if (aText.match(/^\d+/)) {
                    // Check if it's a number
                    aValue = parseInt(aText);
                    bValue = parseInt(bText);
                }
                
                if (newDirection === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            // Reorder table
            rows.forEach(row => tbody.appendChild(row));
        }

        // Template Functions
        function saveTemplateDraft() {
            const form = document.getElementById('templateForm');
            const formData = new FormData(form);
            
            if (!formData.get('templateName')) {
                alert('يرجى إدخال اسم القالب على الأقل');
                return;
            }
            
            alert('تم حفظ القالب كمسودة بنجاح!\n\nيمكنك إكمال التعديل لاحقاً.');
        }

        // Individual send functions
        function confirmIndividualSend() {
            const template = document.getElementById('individualTemplate').value;
            const beneficiary = document.getElementById('beneficiarySelect').value || document.getElementById('beneficiarySearch').value;
            
            if (!template) {
                alert('يرجى اختيار قالب الطرد');
                return;
            }
            
            if (!beneficiary) {
                alert('يرجى اختيار المستفيد');
                return;
            }
            
            const templateText = document.getElementById('individualTemplate').options[document.getElementById('individualTemplate').selectedIndex].text;
            const beneficiaryText = document.getElementById('beneficiarySelect').value ? 
                document.getElementById('beneficiarySelect').options[document.getElementById('beneficiarySelect').selectedIndex].text :
                document.getElementById('beneficiarySearch').value;
            
            const sendId = 'SEND-2024-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            
            if (confirm(`تأكيد الإرسال الفردي:\n\nقالب الطرد: ${templateText}\nالمستفيد: ${beneficiaryText}\n\nهل تريد المتابعة؟`)) {
                alert(`تم إرسال الطرد بنجاح!\n\nرقم الإرسالية: ${sendId}\nنوع الإرسال: فردي\nالمستفيد: ${beneficiaryText}\n\nسيتم البدء في التحضير والتوزيع`);
                
                // Reset form
                document.getElementById('individualTemplate').value = '';
                document.getElementById('beneficiarySelect').value = '';
                document.getElementById('beneficiarySearch').value = '';
                document.getElementById('templateDetails').style.display = 'none';
                document.getElementById('beneficiaryDetails').style.display = 'none';
            }
        }

        // Bulk Send Functions
        function selectTemplate(templateId, element) {
            console.log('selectTemplate called with:', templateId); // Debug log
            
            // Remove selected class from all cards
            document.querySelectorAll('.package-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            element.classList.add('selected');
            
            // Set the hidden input value
            const templateInput = document.getElementById('selectedTemplate');
            if (templateInput) {
                templateInput.value = templateId;
            }
            selectedTemplate = templateId;
            
            console.log('Template selected:', templateId);
            
            // Update beneficiaries preview
            updateBeneficiariesPreview();
        }

        function updateBeneficiariesPreview() {
            const benefitStatus = document.getElementById('benefitStatus').value;
            const familySize = document.getElementById('familySize').value;
            const hasChildren = document.getElementById('hasChildren').value;
            const hasElderly = document.getElementById('hasElderly').value;
            const area = document.getElementById('area').value;
            const lastReceived = document.getElementById('lastReceived').value;
            const dateAdded = document.getElementById('dateAdded').value;

            let filteredBeneficiaries = beneficiariesData.filter(beneficiary => {
                let matches = true;

                if (benefitStatus) {
                    if (benefitStatus === 'never' && beneficiary.lastReceived !== 'never') matches = false;
                    if (benefitStatus === 'recent' && beneficiary.lastReceived === 'never') matches = false;
                    if (benefitStatus === 'old' && (beneficiary.lastReceived === 'never' || beneficiary.lastReceived === 'week')) matches = false;
                    if (benefitStatus === 'new-imported' && beneficiary.dateAdded !== 'today') matches = false;
                }

                if (familySize) {
                    if (familySize === 'small' && beneficiary.familySize !== 'small') matches = false;
                    if (familySize === 'medium' && beneficiary.familySize !== 'medium') matches = false;
                    if (familySize === 'large' && beneficiary.familySize !== 'large') matches = false;
                }

                if (hasChildren) {
                    if (hasChildren === 'yes' && !beneficiary.hasChildren) matches = false;
                    if (hasChildren === 'no' && beneficiary.hasChildren) matches = false;
                }

                if (hasElderly) {
                    if (hasElderly === 'yes' && !beneficiary.hasElderly) matches = false;
                    if (hasElderly === 'no' && beneficiary.hasElderly) matches = false;
                }

                if (area && beneficiary.area !== area) matches = false;

                if (lastReceived && beneficiary.lastReceived !== lastReceived) matches = false;

                if (dateAdded) {
                    if (dateAdded === 'today' && beneficiary.dateAdded !== 'today') matches = false;
                    if (dateAdded === 'week' && !['today', 'week'].includes(beneficiary.dateAdded)) matches = false;
                    if (dateAdded === 'month' && !['today', 'week', 'month'].includes(beneficiary.dateAdded)) matches = false;
                }

                return matches;
            });

            // Update count
            document.getElementById('beneficiariesCount').textContent = `عدد المستفيدين المطابقين: ${filteredBeneficiaries.length}`;

            // Update list
            const listContainer = document.getElementById('beneficiariesList');
            if (filteredBeneficiaries.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">لا يوجد مستفيدين مطابقين للفلاتر المحددة</div>';
            } else {
                let listHtml = '';
                filteredBeneficiaries.slice(0, 10).forEach(beneficiary => {
                    const areaName = getAreaName(beneficiary.area);
                    const familySizeName = getFamilySizeName(beneficiary.familySize);
                    
                    // Add indicator for newly imported
                    const isNewImport = beneficiary.dateAdded === 'today' && beneficiary.id.includes('IMP');
                    const newBadge = isNewImport ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; margin-right: 4px;">جديد</span>' : '';
                    
                    listHtml += `
                        <div class="beneficiary-item">
                            <div>
                                <strong>${beneficiary.name}</strong> ${newBadge}<br>
                                <small>${beneficiary.idNumber} - ${areaName} - ${familySizeName}</small>
                            </div>
                            <div style="text-align: left; font-size: 11px; color: #64748b;">
                                ${beneficiary.hasChildren ? 'لديه أطفال' : ''}<br>
                                ${beneficiary.hasElderly ? 'كبار سن' : ''}
                            </div>
                        </div>
                    `;
                });
                
                if (filteredBeneficiaries.length > 10) {
                    listHtml += `<div style="text-align: center; color: #64748b; padding: 8px;">... و ${filteredBeneficiaries.length - 10} مستفيد آخر</div>`;
                }
                
                listContainer.innerHTML = listHtml;
            }
        }

        function getAreaName(area) {
            const areas = {
                'north': 'شمال غزة',
                'gaza': 'مدينة غزة',
                'middle': 'الوسط',
                'khan-younis': 'خان يونس',
                'rafah': 'رفح'
            };
            return areas[area] || area;
        }

        function getFamilySizeName(size) {
            const sizes = {
                'small': 'أسرة صغيرة (أقل من 5)',
                'medium': 'أسرة متوسطة (5-10)',
                'large': 'أسرة كبيرة (أكثر من 10)'
            };
            return sizes[size] || size;
        }

        function previewSending() {
            if (!selectedTemplate) {
                alert('يرجى اختيار قالب الطرد أولاً');
                return;
            }

            const template = templatesData.find(t => t.id === selectedTemplate);
            if (!template) {
                alert('القالب المحدد غير موجود');
                return;
            }

            // Get current filter values for preview
            const benefitStatus = document.getElementById('benefitStatus').value;
            const familySize = document.getElementById('familySize').value;
            const area = document.getElementById('area').value;
            
            let filterDescription = 'الفلاتر المطبقة:\n';
            if (benefitStatus) filterDescription += `- حالة الاستفادة: ${document.getElementById('benefitStatus').options[document.getElementById('benefitStatus').selectedIndex].text}\n`;
            if (familySize) filterDescription += `- حجم الأسرة: ${document.getElementById('familySize').options[document.getElementById('familySize').selectedIndex].text}\n`;
            if (area) filterDescription += `- المنطقة: ${document.getElementById('area').options[document.getElementById('area').selectedIndex].text}\n`;
            
            const count = document.getElementById('beneficiariesCount').textContent;
            
            alert(`معاينة الإرسال:\n\nقالب الطرد: ${template.name}\nالمؤسسة: ${template.institution}\n\n${filterDescription}\n${count}\n\nهل تريد متابعة الإرسال؟`);
        }

        function confirmBulkSend() {
            if (!selectedInstitution) {
                alert('يرجى اختيار المؤسسة المانحة أولاً');
                return;
            }
            
            if (!selectedTemplate) {
                alert('يرجى اختيار قالب الطرد');
                return;
            }

            const countText = document.getElementById('beneficiariesCount').textContent;
            const count = countText.match(/\d+/)[0];
            
            if (count === '0') {
                alert('لا يوجد مستفيدين مطابقين للفلاتر المحددة');
                return;
            }

            // Get institution name
            const institutionNames = {
                'unrwa': 'الأونروا',
                'wfp': 'برنامج الغذاء العالمي',
                'red-crescent': 'الهلال الأحمر الفلسطيني',
                'who': 'منظمة الصحة العالمية',
                'unicef': 'اليونيسف'
            };
            
            const institutionName = institutionNames[selectedInstitution];
            const template = templatesData.find(t => t.id === selectedTemplate);

            if (confirm(`تأكيد الإرسال الجماعي:\n\nالمؤسسة المانحة: ${institutionName}\nقالب الطرد: ${template.name}\nعدد المستفيدين: ${count}\n\nهل تريد المتابعة؟`)) {
                const sendId = 'SEND-2024-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
                alert(`تم تأكيد الإرسال بنجاح!\n\nرقم الإرسالية: ${sendId}\nالمؤسسة: ${institutionName}\nعدد المستفيدين: ${count}\n\nسيتم البدء في التحضير والتوزيع`);
                
                // Reset form
                selectedTemplate = '';
                selectedInstitution = '';
                document.querySelectorAll('.institution-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelectorAll('.package-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('templatesSection').classList.remove('active');
                document.querySelectorAll('select').forEach(select => {
                    select.value = '';
                });
                updateBeneficiariesPreview();
            }
        }

        // Individual Send Functions
        function searchBeneficiary() {
            const searchTerm = document.getElementById('beneficiarySearch').value.toLowerCase();
            const select = document.getElementById('beneficiarySelect');
            
            // Reset select
            select.innerHTML = '<option value="">اختر المستفيد</option>';
            
            // Filter and add matching beneficiaries
            beneficiariesData.forEach(beneficiary => {
                if (beneficiary.name.toLowerCase().includes(searchTerm) || 
                    beneficiary.idNumber.includes(searchTerm)) {
                    const option = document.createElement('option');
                    option.value = beneficiary.id;
                    option.textContent = `${beneficiary.name} - ${beneficiary.idNumber}`;
                    select.appendChild(option);
                }
            });
        }

        function confirmIndividualSend() {
            const template = document.getElementById('individualTemplate').value;
            const beneficiary = document.getElementById('beneficiarySelect').value;
            
            if (!template || !beneficiary) {
                alert('يرجى اختيار قالب الطرد والمستفيد');
                return;
            }

            const sendId = 'SEND-2024-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            alert(`تم إرسال الطرد بنجاح!\nرقم الإرسالية: ${sendId}\nنوع الإرسال: فردي`);
        }

        // Tracking Functions
        function viewDelivery(sendId) {
            const delivery = deliveriesData.find(d => d.id === sendId);
            if (delivery) {
                // Update modal content with delivery data
                document.getElementById('deliveryId').textContent = delivery.id;
                document.getElementById('packageType').textContent = delivery.package;
                document.getElementById('beneficiaryName').textContent = delivery.beneficiary;
                document.getElementById('deliveryAgent').textContent = delivery.agent;
                document.getElementById('deliveryTime').textContent = `${delivery.time} - ${delivery.date}`;
                document.getElementById('beneficiaryPhone').textContent = delivery.phone;
                document.getElementById('beneficiaryAddress').textContent = delivery.address;
                
                // Show modal
                document.getElementById('deliveryModal').classList.add('active');
                feather.replace();
            } else {
                alert(`عرض تفاصيل الإرسالية: ${sendId}`);
            }
        }

        function trackDelivery(sendId) {
            const delivery = deliveriesData.find(d => d.id === sendId);
            if (delivery && map) {
                // Navigate to tracking page
                showPage('package-tracking');
                
                // Center map on delivery location
                setTimeout(() => {
                    map.setView([delivery.lat, delivery.lng], 15);
                    
                    // Find and open the marker popup
                    markersLayer.eachLayer(layer => {
                        if (layer.getLatLng().lat === delivery.lat && layer.getLatLng().lng === delivery.lng) {
                            layer.openPopup();
                        }
                    });
                }, 500);
            } else {
                alert(`تتبع الإرسالية: ${sendId} على الخريطة`);
            }
        }

        // Click outside modal to close
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // Click outside sidebar to close on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth <= 1024 && 
                !sidebar.contains(event.target) && 
                !menuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Template form submission fix
        function handleTemplateSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const templateData = {
                id: window.editingTemplateId || 'TEMP-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0'),
                name: formData.get('templateName'),
                type: formData.get('templateType'),
                institution: formData.get('institution'),
                institutionName: getInstitutionName(formData.get('institution')),
                description: formData.get('templateDescription'),
                contents: [],
                status: 'active',
                created: new Date().toISOString().split('T')[0]
            };

            // Collect contents data
            const itemNames = formData.getAll('itemName[]');
            const itemQuantities = formData.getAll('itemQuantity[]');
            const itemSizes = formData.getAll('itemSize[]');
            const itemUnits = formData.getAll('itemUnit[]');
            const itemWeights = formData.getAll('itemWeight[]');

            for (let i = 0; i < itemNames.length; i++) {
                if (itemNames[i]) {
                    templateData.contents.push({
                        name: itemNames[i],
                        quantity: parseFloat(itemQuantities[i]) || 0,
                        size: parseFloat(itemSizes[i]) || 0,
                        unit: itemUnits[i],
                        weight: parseFloat(itemWeights[i]) || 0
                    });
                }
            }

            if (window.editingTemplateId) {
                // Update existing template
                const index = templatesData.findIndex(t => t.id === window.editingTemplateId);
                if (index > -1) {
                    templatesData[index] = { ...templatesData[index], ...templateData };
                    alert('تم تحديث قالب الطرد بنجاح!\nمعرف القالب: ' + templateData.id);
                }
                delete window.editingTemplateId;
            } else {
                // Create new template
                templatesData.push(templateData);
                alert('تم إنشاء قالب الطرد بنجاح!\nمعرف القالب: ' + templateData.id);
            }
            
            // Reset form and close modal
            event.target.reset();
            closeModal('templateModal');
            
            // Reset modal state
            document.querySelector('#templateModal .modal-title').textContent = 'إنشاء قالب طرد جديد';
            document.querySelector('#templateForm button[type="submit"]').innerHTML = '<i data-feather="check"></i> إنشاء القالب';
        }

        function getInstitutionName(institutionId) {
            const names = {
                'unrwa': 'الأونروا',
                'wfp': 'برنامج الغذاء العالمي',
                'red-crescent': 'الهلال الأحمر الفلسطيني',
                'who': 'منظمة الصحة العالمية',
                'unicef': 'اليونيسف',
                'unesco': 'منظمة اليونسكو',
                'qatar-charity': 'مؤسسة قطر الخيرية'
            };
            return names[institutionId] || institutionId;
        }

        // Fix template modal opening
        function openTemplateModal() {
            // Reset form if not editing
            if (!window.editingTemplateId) {
                document.getElementById('templateForm').reset();
                document.getElementById('contentsTableBody').innerHTML = `
                    <tr>
                        <td><input type="text" placeholder="مثال: أرز بسمتي" name="itemName[]"></td>
                        <td><input type="number" placeholder="5" name="itemQuantity[]" step="0.1"></td>
                        <td><input type="number" placeholder="1" name="itemSize[]" step="0.1"></td>
                        <td>
                            <select name="itemUnit[]">
                                <option value="كيلو">كيلو</option>
                                <option value="لتر">لتر</option>
                                <option value="عدد">عدد</option>
                                <option value="قطعة">قطعة</option>
                                <option value="علبة">علبة</option>
                                <option value="زوج">زوج</option>
                            </select>
                        </td>
                        <td><input type="number" placeholder="5" name="itemWeight[]" step="0.1"></td>
                        <td>
                            <button type="button" class="action-btn delete" onclick="removeContentsRow(this)">
                                <i data-feather="trash-2" style="width: 12px; height: 12px;"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            const modal = document.getElementById('templateModal');
            modal.classList.add('active');
            feather.replace();
        }

        // Additional utility functions
        function filterInstitutions() {
            const searchTerm = document.getElementById('institutionSearch').value.toLowerCase();
            const institutions = document.querySelectorAll('.institution-item');
            
            institutions.forEach(institution => {
                const name = institution.querySelector('.institution-name-small').textContent.toLowerCase();
                if (name.includes(searchTerm)) {
                    institution.style.display = 'flex';
                } else {
                    institution.style.display = 'none';
                }
            });
        }

        function previewSending() {
            if (!selectedInstitution) {
                alert('يرجى اختيار المؤسسة المانحة أولاً');
                return;
            }
            
            if (!selectedTemplate) {
                alert('يرجى اختيار قالب الطرد');
                return;
            }

            const template = templatesData.find(t => t.id === selectedTemplate);
            const institutionNames = {
                'unrwa': 'الأونروا',
                'wfp': 'برنامج الغذاء العالمي',
                'red-crescent': 'الهلال الأحمر الفلسطيني',
                'who': 'منظمة الصحة العالمية',
                'unicef': 'اليونيسف'
            };

            // Get current filters
            const filters = getCurrentFilters();
            const filteredBeneficiaries = getFilteredBeneficiaries();
            
            if (filteredBeneficiaries.length === 0) {
                alert('لا يوجد مستفيدين مطابقين للفلاتر المحددة');
                return;
            }
            
            // Update preview modal
            document.getElementById('previewInstitution').textContent = institutionNames[selectedInstitution];
            document.getElementById('previewTemplate').textContent = template.name;
            document.getElementById('previewBeneficiariesCount').textContent = `${filteredBeneficiaries.length} مستفيد`;
            
            // Calculate estimated cost
            const estimatedCost = filteredBeneficiaries.length * 80; // $80 per package
            document.getElementById('previewCost').textContent = `${estimatedCost.toLocaleString()}`;
            
            // Show applied filters
            let filtersHtml = '';
            if (filters.benefitStatus) filtersHtml += `<div class="detail-item"><span class="detail-label">حالة الاستفادة:</span><span class="detail-value">${getFilterText('benefitStatus', filters.benefitStatus)}</span></div>`;
            if (filters.familySize) filtersHtml += `<div class="detail-item"><span class="detail-label">حجم الأسرة:</span><span class="detail-value">${getFilterText('familySize', filters.familySize)}</span></div>`;
            if (filters.area) filtersHtml += `<div class="detail-item"><span class="detail-label">المنطقة:</span><span class="detail-value">${getAreaName(filters.area)}</span></div>`;
            
            if (!filtersHtml) {
                filtersHtml = '<div style="color: #6b7280; font-style: italic;">لا توجد فلاتر مطبقة</div>';
            }
            document.getElementById('previewFilters').innerHTML = filtersHtml;
            
            // Show sample beneficiaries
            let beneficiariesHtml = '';
            filteredBeneficiaries.slice(0, 10).forEach((beneficiary, index) => {
                beneficiariesHtml += `
                    <div style="padding: 8px 12px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                        <div>
                            <strong>${beneficiary.name}</strong><br>
                            <small>${beneficiary.idNumber} - ${getAreaName(beneficiary.area)}</small>
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">#${index + 1}</div>
                    </div>
                `;
            });
            
            if (filteredBeneficiaries.length > 10) {
                beneficiariesHtml += `<div style="padding: 12px; text-align: center; color: #6b7280; font-style: italic;">... و ${filteredBeneficiaries.length - 10} مستفيد آخر</div>`;
            }
            
            document.getElementById('previewBeneficiariesList').innerHTML = beneficiariesHtml;
            
            // Show modal
            document.getElementById('previewSendModal').classList.add('active');
            feather.replace();
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - Starting initialization...'); // Debug log
            
            feather.replace();
            
            // Set current date for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });

            // Initialize map when tracking page is loaded
            setTimeout(() => {
                initializeMap();
            }, 1000);

            // Initialize beneficiaries preview
            updateBeneficiariesPreview();

            // Update individual template options
            try {
                updateIndividualTemplateOptions();
                console.log('Individual template options updated successfully');
            } catch (error) {
                console.error('Error updating individual template options:', error);
            }

            // Setup drag and drop for file import
            const importSection = document.querySelector('.import-section');
            if (importSection) {
                importSection.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                importSection.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                importSection.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('beneficiariesFile').files = files;
                        handleFileImport(document.getElementById('beneficiariesFile'));
                    }
                });
            }

            // Setup individual template change handler
            const individualTemplateSelect = document.getElementById('individualTemplate');
            if (individualTemplateSelect) {
                individualTemplateSelect.addEventListener('change', handleIndividualTemplateChange);
                console.log('Individual template change handler setup');
            }

            // Setup beneficiary select change handler
            const beneficiarySelect = document.getElementById('beneficiarySelect');
            if (beneficiarySelect) {
                beneficiarySelect.addEventListener('change', handleBeneficiarySelectChange);
                console.log('Beneficiary select change handler setup');
            }

            // Setup click outside to hide search results
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.beneficiary-search-results') && !e.target.closest('#beneficiarySearch')) {
                    const results = document.getElementById('searchResults');
                    if (results) {
                        results.style.display = 'none';
                    }
                }
            });

            // Debug: Log templates data
            console.log('Templates loaded:', templatesData.length, 'templates');
            console.log('Beneficiaries loaded:', beneficiariesData.length, 'beneficiaries');
            
            // Test functions availability
            console.log('Functions check:');
            console.log('- selectInstitutionQuick:', typeof selectInstitutionQuick);
            console.log('- selectInstitutionFromList:', typeof selectInstitutionFromList);
            console.log('- showRealExample:', typeof showRealExample);
            console.log('- updateIndividualTemplateOptions:', typeof updateIndividualTemplateOptions);
            
            console.log('Initialization complete!');
        });

        // Legacy function for backward compatibility
        function searchBeneficiary() {
            searchBeneficiaryLive();
        }

        // Re-initialize icons when content changes
        function reinitializeIcons() {
            setTimeout(() => {
                feather.replace();
            }, 100);
        }

        // Call reinitializeIcons after any dynamic content changes
        const observer = new MutationObserver(reinitializeIcons);
        observer.observe(document.body, { childList: true, subtree: true });

    </script>
</body>
</html>